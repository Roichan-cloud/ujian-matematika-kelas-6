<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ujian Matematika - UPT SDN BAKALAN</title>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Baloo+2:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* ============================================================
   CSS VARIABLES & THEME
============================================================ */
:root {
  --navy: #1a2f5e;
  --blue: #2563eb;
  --sky: #38bdf8;
  --gold: #f59e0b;
  --green: #22c55e;
  --red: #ef4444;
  --purple: #7c3aed;

  --bg-body: linear-gradient(135deg, #1a2f5e 0%, #1e3a8a 40%, #1e40af 100%);
  --card-bg: #ffffff;
  --card-border: rgba(0,0,0,0.06);
  --text-primary: #1a2f5e;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --input-bg: #f8fafc;
  --input-border: #e2e8f0;
  --input-focus: #2563eb;
  --question-bg: #f8fafc;
  --question-border: #e2e8f0;
  --question-answered-bg: #f0fdf4;
  --question-answered-border: #86efac;
  --option-bg: #ffffff;
  --option-border: #e2e8f0;
  --option-hover-border: #38bdf8;
  --option-hover-bg: #f0f9ff;
  --section-bg: #f1f5f9;
  --divider: #f1f5f9;
  --shadow: 0 25px 60px rgba(0,0,0,0.25);
}

[data-theme="dark"] {
  --bg-body: linear-gradient(135deg, #0a0f1e 0%, #0f1b35 40%, #111827 100%);
  --card-bg: #1e293b;
  --card-border: rgba(255,255,255,0.08);
  --text-primary: #e2e8f0;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --input-bg: #0f172a;
  --input-border: #334155;
  --input-focus: #38bdf8;
  --question-bg: #0f172a;
  --question-border: #334155;
  --question-answered-bg: #052e16;
  --question-answered-border: #16a34a;
  --option-bg: #1e293b;
  --option-border: #334155;
  --option-hover-border: #38bdf8;
  --option-hover-bg: #0c1a2e;
  --section-bg: #0f172a;
  --divider: #334155;
  --shadow: 0 25px 60px rgba(0,0,0,0.6);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Nunito', sans-serif;
  background: var(--bg-body);
  min-height: 100vh;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding: 24px 16px;
  position: relative;
  overflow-x: hidden;
  transition: background 0.4s ease;
}

body::before {
  content: '';
  position: fixed;
  top: -50%; left: -50%;
  width: 200%; height: 200%;
  background:
    radial-gradient(circle at 25% 45%, rgba(56,189,248,0.07) 0%, transparent 50%),
    radial-gradient(circle at 75% 20%, rgba(245,158,11,0.05) 0%, transparent 40%),
    radial-gradient(circle at 50% 80%, rgba(124,58,237,0.05) 0%, transparent 40%);
  pointer-events: none;
  z-index: 0;
}

/* FLOATING SHAPES */
.floating-shapes {
  position: fixed; top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none; z-index: 0; overflow: hidden;
}
.shape {
  position: absolute; opacity: 0.05;
  animation: floatShape 10s ease-in-out infinite;
  font-size: clamp(40px, 8vw, 100px);
  filter: blur(1px);
}
.shape:nth-child(1) { top:8%; left:4%; animation-delay:0s; }
.shape:nth-child(2) { top:55%; left:88%; animation-delay:2.5s; }
.shape:nth-child(3) { top:78%; left:8%; animation-delay:5s; }
.shape:nth-child(4) { top:18%; left:78%; animation-delay:1.2s; }
.shape:nth-child(5) { top:42%; left:48%; animation-delay:3.5s; }
.shape:nth-child(6) { top:90%; left:60%; animation-delay:7s; }

@keyframes floatShape {
  0%, 100% { transform: translateY(0) rotate(0deg) scale(1); }
  33% { transform: translateY(-18px) rotate(8deg) scale(1.05); }
  66% { transform: translateY(8px) rotate(-5deg) scale(0.95); }
}

/* CONTAINER */
.container {
  position: relative; z-index: 1;
  width: 100%; max-width: 800px;
  padding-top: 8px;
}

/* SCHOOL HEADER */
.school-header {
  text-align: center; color: white;
  margin-bottom: 20px;
  animation: slideDown 0.7s cubic-bezier(0.34,1.56,0.64,1);
}
.logo-area {
  display: flex; align-items: center;
  justify-content: center; gap: 14px; margin-bottom: 6px;
}
.school-logo {
  width: 60px; height: 60px;
  background: linear-gradient(135deg, var(--gold), #fbbf24);
  border-radius: 16px;
  display: flex; align-items: center; justify-content: center;
  font-size: 30px;
  box-shadow: 0 6px 24px rgba(245,158,11,0.5);
  animation: logoPulse 3s ease-in-out infinite;
}
@keyframes logoPulse {
  0%,100% { box-shadow: 0 6px 24px rgba(245,158,11,0.5); }
  50% { box-shadow: 0 8px 32px rgba(245,158,11,0.8); }
}
.school-header h1 {
  font-family: 'Baloo 2', sans-serif;
  font-size: clamp(18px, 4vw, 24px);
  font-weight: 800; line-height: 1.2;
  text-shadow: 0 2px 8px rgba(0,0,0,0.4);
}
.school-header h1 span {
  display: block; font-size: 12px; font-weight: 600;
  color: var(--sky); letter-spacing: 2.5px; text-transform: uppercase;
  margin-top: 2px;
}

/* DARK MODE TOGGLE */
.dark-toggle {
  position: fixed; top: 18px; right: 18px; z-index: 200;
  background: rgba(255,255,255,0.15);
  border: 2px solid rgba(255,255,255,0.25);
  border-radius: 50px;
  padding: 8px 16px;
  color: white; font-size: 13px; font-weight: 700;
  cursor: pointer; backdrop-filter: blur(10px);
  transition: all 0.3s; display: flex; align-items: center; gap: 6px;
}
.dark-toggle:hover { background: rgba(255,255,255,0.25); transform: scale(1.05); }

/* CARD */
.card {
  background: var(--card-bg);
  border-radius: 24px;
  padding: 36px;
  box-shadow: var(--shadow), 0 0 0 1px var(--card-border);
  transition: background 0.4s, box-shadow 0.4s;
}
.card-enter {
  animation: cardEnter 0.5s cubic-bezier(0.34,1.3,0.64,1) forwards;
}
@keyframes cardEnter {
  from { opacity:0; transform:translateY(24px) scale(0.98); }
  to { opacity:1; transform:translateY(0) scale(1); }
}

@keyframes slideDown { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
@keyframes slideUp { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }

/* ============================================================
   LOGIN PAGE
============================================================ */
.login-title {
  font-family: 'Baloo 2', sans-serif;
  font-size: clamp(22px, 5vw, 28px);
  font-weight: 800; color: var(--text-primary);
  text-align: center; margin-bottom: 4px;
}
.login-subtitle {
  text-align: center; color: var(--text-secondary);
  font-size: 14px; margin-bottom: 28px; line-height: 1.5;
}
.badge-mat {
  display: inline-block;
  background: linear-gradient(135deg, var(--blue), var(--sky));
  color: white; font-size: 11px; font-weight: 700;
  padding: 5px 16px; border-radius: 20px;
  letter-spacing: 1px; margin-bottom: 18px;
  box-shadow: 0 4px 12px rgba(37,99,235,0.3);
}
.form-group { margin-bottom: 18px; }
label {
  display: block; font-weight: 700;
  color: var(--text-primary); margin-bottom: 7px; font-size: 14px;
}
input[type="text"], select {
  width: 100%; padding: 13px 16px;
  border: 2px solid var(--input-border);
  border-radius: 12px;
  font-family: 'Nunito', sans-serif; font-size: 15px;
  color: var(--text-primary);
  background: var(--input-bg);
  outline: none; transition: all 0.25s;
}
input[type="text"]:focus, select:focus {
  border-color: var(--input-focus);
  background: var(--card-bg);
  box-shadow: 0 0 0 4px rgba(37,99,235,0.12);
  transform: translateY(-1px);
}
select option { background: var(--card-bg); color: var(--text-primary); }

.btn-start {
  width: 100%; padding: 15px;
  background: linear-gradient(135deg, var(--navy), var(--blue));
  color: white; border: none; border-radius: 14px;
  font-family: 'Baloo 2', sans-serif; font-size: 18px; font-weight: 700;
  cursor: pointer; transition: all 0.3s;
  box-shadow: 0 6px 20px rgba(37,99,235,0.4); letter-spacing: 0.5px;
  position: relative; overflow: hidden;
}
.btn-start::after {
  content: '';
  position: absolute; top: 50%; left: 50%;
  width: 0; height: 0;
  background: rgba(255,255,255,0.2);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.5s, height 0.5s;
}
.btn-start:hover::after { width: 300px; height: 300px; }
.btn-start:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(37,99,235,0.5); }
.btn-start:active { transform: translateY(0); }

.info-cards {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 10px; margin-top: 22px;
}
.info-card {
  background: linear-gradient(135deg, #eff6ff, #e0f2fe);
  border-radius: 14px; padding: 16px 12px; text-align: center;
  border: 1px solid rgba(37,99,235,0.1);
  transition: transform 0.2s;
}
[data-theme="dark"] .info-card {
  background: linear-gradient(135deg, #0c1a2e, #0f2040);
  border-color: rgba(56,189,248,0.15);
}
.info-card:hover { transform: translateY(-3px); }
.info-card .num {
  font-family: 'Baloo 2', sans-serif; font-size: 26px;
  font-weight: 800; color: var(--blue);
}
.info-card .lbl { font-size: 11px; color: var(--text-secondary); font-weight: 700; margin-top: 2px; }

/* RULES BOX */
.rules-box {
  margin-top: 20px;
  background: linear-gradient(135deg, #fef3c7, #fef9ee);
  border: 2px solid #fcd34d;
  border-radius: 14px; padding: 16px 18px;
}
[data-theme="dark"] .rules-box {
  background: linear-gradient(135deg, #1a1200, #1f1500);
  border-color: #92400e;
}
.rules-box h4 {
  font-size: 13px; font-weight: 800; color: #92400e;
  margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
}
[data-theme="dark"] .rules-box h4 { color: #fcd34d; }
.rules-box ul {
  list-style: none; padding: 0;
}
.rules-box ul li {
  font-size: 12px; color: #78350f; font-weight: 600;
  padding: 3px 0; display: flex; gap: 6px;
}
[data-theme="dark"] .rules-box ul li { color: #fde68a; }

/* ============================================================
   SECURITY BAR
============================================================ */
.security-bar {
  display: flex; align-items: center; justify-content: space-between;
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  border-radius: 12px; padding: 10px 16px;
  margin-bottom: 16px; color: white;
  box-shadow: 0 4px 16px rgba(220,38,38,0.35);
}
.security-bar.safe {
  background: linear-gradient(135deg, #059669, #047857);
  box-shadow: 0 4px 16px rgba(5,150,105,0.3);
}
.sec-left { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 700; }
.sec-badge {
  background: rgba(255,255,255,0.2);
  border-radius: 20px; padding: 3px 10px;
  font-size: 11px; font-weight: 800; letter-spacing: 1px;
}
.violation-count {
  font-size: 12px; font-weight: 600; opacity: 0.9;
}

/* ============================================================
   EXAM PAGE
============================================================ */
.exam-header {
  display: flex; align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 20px; padding-bottom: 16px;
  border-bottom: 2px solid var(--divider);
  flex-wrap: wrap; gap: 12px;
}
.exam-info h2 {
  font-family: 'Baloo 2', sans-serif; font-size: 20px;
  font-weight: 800; color: var(--text-primary);
}
.exam-info p { font-size: 13px; color: var(--text-secondary); font-weight: 600; }
.progress-wrap { min-width: 180px; }
.progress-text { font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; font-weight: 700; text-align: right; }
.progress-bar-bg {
  height: 10px; background: var(--question-border);
  border-radius: 10px; overflow: hidden;
}
.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--blue), var(--sky), var(--green));
  background-size: 200% 100%;
  border-radius: 10px; transition: width 0.5s ease;
  animation: shimmerBar 2s linear infinite;
}
@keyframes shimmerBar {
  0% { background-position: 200% center; }
  100% { background-position: 0% center; }
}
.progress-pct {
  font-size: 11px; color: var(--text-muted);
  text-align: right; margin-top: 3px; font-weight: 600;
}

/* SOAL NAVIGATOR */
.soal-nav {
  display: flex; flex-wrap: wrap; gap: 6px;
  margin-bottom: 20px; padding: 14px;
  background: var(--section-bg); border-radius: 14px;
}
.soal-nav-title {
  width: 100%; font-size: 11px; font-weight: 800;
  color: var(--text-muted); text-transform: uppercase;
  letter-spacing: 1px; margin-bottom: 6px;
}
.nav-dot {
  width: 30px; height: 30px; border-radius: 8px;
  font-size: 11px; font-weight: 800;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all 0.2s;
  border: 2px solid var(--option-border);
  background: var(--option-bg);
  color: var(--text-secondary);
}
.nav-dot:hover { transform: scale(1.1); }
.nav-dot.done { background: var(--green); border-color: var(--green); color: white; }
.nav-dot.pg { }
.nav-dot.bs { border-style: dashed; }
.nav-dot.is { border-radius: 50%; }

/* SECTION TITLE */
.section-title {
  display: flex; align-items: center; gap: 10px;
  margin: 24px 0 14px;
}
.section-badge {
  background: linear-gradient(135deg, var(--navy), var(--blue));
  color: white;
  font-family: 'Baloo 2', sans-serif; font-size: 13px; font-weight: 700;
  padding: 7px 18px; border-radius: 20px; letter-spacing: 0.5px;
  white-space: nowrap;
  box-shadow: 0 4px 12px rgba(37,99,235,0.3);
}
.section-line { flex: 1; height: 2px; background: linear-gradient(90deg, var(--sky), transparent); border-radius: 2px; }
.section-desc { font-size: 12px; color: var(--text-muted); font-weight: 600; margin-bottom: 12px; font-style: italic; }

/* QUESTION CARD */
.question-card {
  background: var(--question-bg);
  border: 2px solid var(--question-border);
  border-radius: 16px; padding: 20px;
  margin-bottom: 12px; position: relative;
  transition: all 0.35s ease;
  animation: questionAppear 0.4s ease backwards;
}
@keyframes questionAppear {
  from { opacity:0; transform:translateY(10px); }
  to { opacity:1; transform:translateY(0); }
}
.question-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
.question-card.answered {
  border-color: var(--green);
  border-width: 2.5px;
  background: var(--question-answered-bg);
  box-shadow: 0 0 0 3px rgba(34,197,94,0.15);
}

.question-num {
  font-size: 11px; font-weight: 800; color: var(--blue);
  text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px;
}
.question-text {
  font-size: 15px; font-weight: 700; color: var(--text-primary);
  margin-bottom: 14px; line-height: 1.6;
}
.answered-check { display: none !important; }

/* WATERMARK */
.watermark-layer {
  position: fixed; inset: 0; z-index: 2;
  pointer-events: none; overflow: hidden;
  display: flex; flex-wrap: wrap;
  align-items: flex-start; justify-content: flex-start;
  padding: 20px; gap: 0;
  opacity: 0; transition: opacity 0.5s;
}
.watermark-layer.active { opacity: 1; }
.watermark-text {
  font-size: 15px; font-weight: 800;
  color: rgba(37,99,235,0.09);
  transform: rotate(-30deg);
  white-space: nowrap;
  padding: 28px 18px;
  user-select: none;
  letter-spacing: 1px;
}
[data-theme="dark"] .watermark-text {
  color: rgba(56,189,248,0.07);
}

/* ANIMASI NILAI */
.nilai-num {
  font-family: 'Baloo 2', sans-serif; font-size: 80px; font-weight: 800;
  line-height: 1; margin: 4px 0;
}
@keyframes nilaiMuncul {
  0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
  60% { transform: scale(1.15) rotate(3deg); opacity: 1; }
  80% { transform: scale(0.95) rotate(-1deg); }
  100% { transform: scale(1) rotate(0deg); opacity: 1; }
}
.nilai-num.animating { animation: nilaiMuncul 0.7s cubic-bezier(0.34,1.56,0.64,1) forwards; }

/* OPTIONS */
.options-grid { display: grid; gap: 8px; }
.option-label {
  display: flex; align-items: center; gap: 12px;
  padding: 11px 14px;
  border: 2px solid var(--option-border);
  border-radius: 12px; cursor: pointer;
  transition: all 0.2s; background: var(--option-bg);
  font-size: 14px; font-weight: 600; color: var(--text-primary);
}
.option-label:hover { border-color: var(--sky); background: var(--option-hover-bg); transform: translateX(2px); }
.option-label input[type="radio"] { display: none; }
.option-label.selected { border-color: var(--blue); background: var(--option-hover-bg); color: var(--blue); }
.opt-letter {
  width: 30px; height: 30px; border-radius: 8px;
  background: var(--section-bg);
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 13px; flex-shrink: 0; transition: all 0.2s;
  color: var(--text-secondary);
}
.selected .opt-letter { background: var(--blue); color: white; }

/* BS BUTTONS */
.bs-options { display: flex; gap: 10px; }
.bs-btn {
  flex: 1; padding: 12px;
  border: 2px solid var(--option-border); border-radius: 12px;
  background: var(--option-bg);
  font-family: 'Nunito', sans-serif; font-size: 14px; font-weight: 800;
  cursor: pointer; transition: all 0.2s; color: var(--text-secondary);
}
.bs-btn:hover { transform: translateY(-1px); }
.bs-btn.selected-true { border-color: var(--green); background: var(--question-answered-bg); color: var(--green); }
.bs-btn.selected-false { border-color: var(--red); background: #fef2f2; color: var(--red); }
[data-theme="dark"] .bs-btn.selected-false { background: #1a0000; }

/* ISIAN */
.isian-input {
  width: 100%; padding: 12px 16px;
  border: 2px solid var(--option-border); border-radius: 12px;
  font-family: 'Nunito', sans-serif; font-size: 15px; font-weight: 700;
  color: var(--text-primary); background: var(--option-bg);
  outline: none; transition: all 0.25s;
}
.isian-input:focus {
  border-color: var(--blue);
  box-shadow: 0 0 0 4px rgba(37,99,235,0.1);
  transform: translateY(-1px);
}

/* BOTTOM BAR */
.bottom-bar {
  position: sticky; bottom: 0;
  background: var(--card-bg);
  padding: 16px 0 0; margin-top: 20px;
  border-top: 2px solid var(--divider);
}
.submit-btn {
  width: 100%; padding: 16px;
  background: linear-gradient(135deg, #059669, var(--green));
  color: white; border: none; border-radius: 14px;
  font-family: 'Baloo 2', sans-serif; font-size: 18px; font-weight: 700;
  cursor: pointer; transition: all 0.3s;
  box-shadow: 0 6px 20px rgba(34,197,94,0.4); letter-spacing: 0.5px;
  position: relative; overflow: hidden;
}
.submit-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(34,197,94,0.5); }

/* ============================================================
   MODAL
============================================================ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(8,15,30,0.75);
  display: flex; align-items: center; justify-content: center;
  z-index: 1000; padding: 20px; backdrop-filter: blur(8px);
}
.modal-box {
  background: var(--card-bg);
  border-radius: 28px; padding: 36px;
  max-width: 420px; width: 100%; text-align: center;
  animation: popIn 0.4s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow: 0 40px 100px rgba(0,0,0,0.5), 0 0 0 1px var(--card-border);
}
@keyframes popIn { from { opacity:0; transform:scale(0.75) translateY(20px); } to { opacity:1; transform:scale(1) translateY(0); } }
.modal-icon { font-size: 56px; margin-bottom: 12px; animation: wiggle 1s ease infinite; }
@keyframes wiggle { 0%,100%{transform:rotate(-5deg);} 50%{transform:rotate(5deg);} }
.modal-box h3 {
  font-family: 'Baloo 2', sans-serif; font-size: 22px;
  font-weight: 800; color: var(--text-primary); margin-bottom: 10px; line-height: 1.3;
}
.modal-box p { color: var(--text-secondary); font-size: 14px; margin-bottom: 24px; line-height: 1.6; }
.modal-btns { display: flex; gap: 12px; }
.btn-cek {
  flex: 1; padding: 13px;
  border: 2px solid var(--option-border); border-radius: 12px;
  background: var(--option-bg); font-family: 'Nunito', sans-serif;
  font-size: 15px; font-weight: 700; cursor: pointer;
  color: var(--text-secondary); transition: all 0.2s;
}
.btn-cek:hover { border-color: var(--blue); color: var(--blue); }
.btn-iya {
  flex: 1; padding: 13px; border: none; border-radius: 12px;
  background: linear-gradient(135deg, #059669, var(--green));
  color: white; font-family: 'Nunito', sans-serif;
  font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(34,197,94,0.35);
}
.btn-iya:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(34,197,94,0.5); }

/* SECURITY MODAL */
.modal-box.danger { border: 3px solid var(--red); }
.modal-box.danger .modal-icon { animation: shake 0.5s ease; }
@keyframes shake {
  0%,100%{transform:translateX(0);}
  20%{transform:translateX(-8px);}
  40%{transform:translateX(8px);}
  60%{transform:translateX(-5px);}
  80%{transform:translateX(5px);}
}
.btn-dismiss {
  width: 100%; padding: 13px; border: none; border-radius: 12px;
  background: linear-gradient(135deg, var(--red), #dc2626);
  color: white; font-family: 'Nunito', sans-serif;
  font-size: 15px; font-weight: 800; cursor: pointer;
  box-shadow: 0 4px 16px rgba(239,68,68,0.4); transition: all 0.2s;
}
.btn-dismiss:hover { transform: translateY(-1px); }

/* ============================================================
   HASIL PAGE
============================================================ */
.hasil-header {
  text-align: center; padding: 20px 0 18px;
  border-bottom: 2px solid var(--divider); margin-bottom: 22px;
}
.hasil-icon { font-size: 64px; margin-bottom: 10px; display: block; animation: celebrateIcon 0.6s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes celebrateIcon { from{transform:scale(0) rotate(-180deg);} to{transform:scale(1) rotate(0deg);} }
.hasil-header h2 {
  font-family: 'Baloo 2', sans-serif; font-size: 26px;
  font-weight: 800; color: var(--text-primary); margin-bottom: 4px;
}
.peserta-name { font-size: 16px; color: var(--blue); font-weight: 700; }
.nilai-box {
  text-align: center; margin: 20px 0;
  padding: 28px; border-radius: 22px; color: white;
  background: linear-gradient(135deg, var(--navy), var(--blue));
  position: relative; overflow: hidden;
}
.nilai-box::before {
  content: '‚ú¶';
  position: absolute; right: -20px; bottom: -20px;
  font-size: 120px; opacity: 0.07; transform: rotate(-15deg);
}
.nilai-box::after {
  content: '‚ú¶';
  position: absolute; left: -10px; top: -10px;
  font-size: 80px; opacity: 0.07; transform: rotate(30deg);
}
.nilai-label { font-size: 12px; font-weight: 800; letter-spacing: 2.5px; text-transform: uppercase; color: var(--sky); margin-bottom: 6px; }
.nilai-predikat { font-size: 16px; font-weight: 800; color: var(--gold); margin-top: 4px; }

.stats-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 20px; }
.stat-card { padding: 18px 10px; border-radius: 16px; text-align: center; }
.stat-card.total { background: linear-gradient(135deg,#eff6ff,#dbeafe); }
.stat-card.benar { background: linear-gradient(135deg,#f0fdf4,#dcfce7); }
.stat-card.salah { background: linear-gradient(135deg,#fef2f2,#fee2e2); }
[data-theme="dark"] .stat-card.total { background: linear-gradient(135deg,#0c1a2e,#0f2040); }
[data-theme="dark"] .stat-card.benar { background: linear-gradient(135deg,#052e16,#14532d); }
[data-theme="dark"] .stat-card.salah { background: linear-gradient(135deg,#1a0000,#2d0000); }
.stat-card .s-num { font-family:'Baloo 2',sans-serif; font-size:34px; font-weight:800; }
.stat-card.total .s-num { color:var(--blue); }
.stat-card.benar .s-num { color:var(--green); }
.stat-card.salah .s-num { color:var(--red); }
.stat-card .s-lbl { font-size:12px; font-weight:700; color:var(--text-secondary); }

.section-stat { background:var(--section-bg); border-radius:14px; padding:14px 18px; margin-bottom:10px; }
.section-stat-title { font-size:13px; font-weight:800; color:var(--text-primary); margin-bottom:8px; display:flex; justify-content:space-between; }
.mini-bar-wrap { height:10px; background:var(--question-border); border-radius:10px; overflow:hidden; }
.mini-bar-fill { height:100%; border-radius:10px; transition:width 1s ease; }
.mini-bar-fill.pg { background:linear-gradient(90deg,var(--blue),var(--sky)); }
.mini-bar-fill.bs { background:linear-gradient(90deg,var(--purple),#a78bfa); }
.mini-bar-fill.is { background:linear-gradient(90deg,var(--gold),#fbbf24); }

.violation-result {
  display:flex; align-items:center; gap:10px;
  background: linear-gradient(135deg,#fef2f2,#fee2e2);
  border:2px solid #fca5a5; border-radius:12px; padding:12px 16px;
  margin-bottom: 16px;
}
[data-theme="dark"] .violation-result { background: linear-gradient(135deg,#1a0000,#2d0000); border-color:#7f1d1d; }
.violation-result .v-icon { font-size:20px; }
.violation-result .v-text { font-size:13px; font-weight:700; color:#dc2626; }
[data-theme="dark"] .violation-result .v-text { color:#fca5a5; }

.btn-ulang {
  width:100%; padding:15px;
  background:linear-gradient(135deg,var(--navy),var(--blue));
  color:white; border:none; border-radius:14px;
  font-family:'Baloo 2',sans-serif; font-size:17px; font-weight:700;
  cursor:pointer; transition:all 0.3s;
  box-shadow:0 6px 20px rgba(37,99,235,0.35); margin-top:20px;
}
.btn-ulang:hover { transform:translateY(-2px); box-shadow:0 12px 32px rgba(37,99,235,0.5); }

/* SCREEN BLOCK OVERLAY */
.screen-block {
  position: fixed; inset: 0; z-index: 9999;
  background: rgba(8,8,20,0.97);
  display: flex; align-items: center; justify-content: center;
  padding: 20px; backdrop-filter: blur(20px);
}
.screen-block-content { text-align: center; color: white; max-width: 400px; }
.screen-block-icon { font-size: 72px; margin-bottom: 16px; animation: shake 0.5s ease; }
.screen-block h2 {
  font-family: 'Baloo 2', sans-serif; font-size: 28px; font-weight: 800;
  margin-bottom: 10px; color: #fca5a5;
}
.screen-block p { font-size: 15px; color: #94a3b8; line-height: 1.6; margin-bottom: 24px; }
.screen-block .warning-count {
  display: inline-block;
  background: linear-gradient(135deg, var(--red), #dc2626);
  color: white; font-family: 'Baloo 2', sans-serif;
  font-size: 16px; font-weight: 800;
  padding: 10px 24px; border-radius: 30px;
  box-shadow: 0 4px 20px rgba(239,68,68,0.5);
  margin-bottom: 20px;
}
.btn-kembali-ujian {
  padding: 14px 32px;
  background: linear-gradient(135deg, var(--blue), var(--sky));
  color: white; border: none; border-radius: 14px;
  font-family: 'Nunito', sans-serif; font-size: 16px; font-weight: 800;
  cursor: pointer; transition: all 0.3s;
  box-shadow: 0 6px 20px rgba(37,99,235,0.4);
}
.btn-kembali-ujian:hover { transform: translateY(-2px); }

/* ============================================================
   ADMIN PAGE
============================================================ */
.admin-login-icon { font-size: 48px; text-align: center; margin-bottom: 12px; }
.admin-badge {
  display: inline-block;
  background: linear-gradient(135deg, #7c3aed, #a78bfa);
  color: white; font-size: 11px; font-weight: 700;
  padding: 5px 16px; border-radius: 20px; letter-spacing: 1px;
  margin-bottom: 18px;
  box-shadow: 0 4px 12px rgba(124,58,237,0.3);
}
.btn-admin-login {
  width: 100%; padding: 14px;
  background: linear-gradient(135deg, #7c3aed, #6d28d9);
  color: white; border: none; border-radius: 14px;
  font-family: 'Baloo 2', sans-serif; font-size: 17px; font-weight: 700;
  cursor: pointer; transition: all 0.3s;
  box-shadow: 0 6px 20px rgba(124,58,237,0.4);
}
.btn-admin-login:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(124,58,237,0.5); }
.btn-back-login {
  width: 100%; padding: 12px; margin-top: 10px;
  background: transparent; border: 2px solid var(--option-border);
  border-radius: 12px; color: var(--text-secondary);
  font-family: 'Nunito', sans-serif; font-size: 14px; font-weight: 700;
  cursor: pointer; transition: all 0.2s;
}
.btn-back-login:hover { border-color: var(--blue); color: var(--blue); }

/* ADMIN DASHBOARD */
.admin-topbar {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 22px; padding-bottom: 16px;
  border-bottom: 2px solid var(--divider); flex-wrap: wrap; gap: 10px;
}
.admin-topbar h2 {
  font-family: 'Baloo 2', sans-serif; font-size: 22px;
  font-weight: 800; color: var(--text-primary);
}
.admin-topbar p { font-size: 13px; color: var(--text-secondary); font-weight: 600; }
.btn-admin-logout {
  padding: 8px 18px; border: 2px solid var(--red);
  border-radius: 10px; background: transparent;
  color: var(--red); font-family: 'Nunito', sans-serif;
  font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s;
}
.btn-admin-logout:hover { background: var(--red); color: white; }

.admin-stats {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 10px; margin-bottom: 20px;
}
.admin-stat {
  padding: 16px 12px; border-radius: 14px; text-align: center;
  background: var(--section-bg);
}
.admin-stat .as-num {
  font-family: 'Baloo 2', sans-serif; font-size: 28px; font-weight: 800;
  color: var(--blue);
}
.admin-stat .as-lbl { font-size: 11px; color: var(--text-secondary); font-weight: 700; }

.filter-bar {
  display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;
}
.filter-btn {
  padding: 7px 16px; border-radius: 20px;
  border: 2px solid var(--option-border);
  background: var(--option-bg); color: var(--text-secondary);
  font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 700;
  cursor: pointer; transition: all 0.2s;
}
.filter-btn.active { border-color: var(--blue); background: #eff6ff; color: var(--blue); }
[data-theme="dark"] .filter-btn.active { background: #0c1a2e; }
.filter-btn:hover { border-color: var(--sky); }

.rekap-table { width: 100%; border-collapse: collapse; }
.rekap-table th {
  background: linear-gradient(135deg, var(--navy), var(--blue));
  color: white; padding: 10px 12px; font-size: 12px;
  font-weight: 800; text-align: left; letter-spacing: 0.5px;
}
.rekap-table th:first-child { border-radius: 10px 0 0 10px; }
.rekap-table th:last-child { border-radius: 0 10px 10px 0; }
.rekap-table td {
  padding: 10px 12px; font-size: 13px; font-weight: 600;
  color: var(--text-primary); border-bottom: 1px solid var(--divider);
}
.rekap-table tr:last-child td { border-bottom: none; }
.rekap-table tr:hover td { background: var(--section-bg); }
.nilai-pill {
  display: inline-block; padding: 3px 12px; border-radius: 20px;
  font-size: 12px; font-weight: 800;
}
.nilai-pill.a { background: #dcfce7; color: #16a34a; }
.nilai-pill.b { background: #dbeafe; color: #1d4ed8; }
.nilai-pill.c { background: #fef9c3; color: #a16207; }
.nilai-pill.d { background: #fee2e2; color: #dc2626; }
[data-theme="dark"] .nilai-pill.a { background: #052e16; color: #4ade80; }
[data-theme="dark"] .nilai-pill.b { background: #0c1a2e; color: #60a5fa; }
[data-theme="dark"] .nilai-pill.c { background: #1a1200; color: #fde047; }
[data-theme="dark"] .nilai-pill.d { background: #1a0000; color: #f87171; }

.pelanggaran-dot {
  display: inline-block; width: 8px; height: 8px; border-radius: 50%;
  margin-right: 4px;
}
.no-data {
  text-align: center; padding: 40px 20px;
  color: var(--text-muted); font-size: 14px; font-weight: 600;
}
.no-data span { font-size: 36px; display: block; margin-bottom: 8px; }

.btn-hapus-data {
  width: 100%; padding: 12px; margin-top: 16px;
  background: transparent; border: 2px solid var(--red);
  border-radius: 12px; color: var(--red);
  font-family: 'Nunito', sans-serif; font-size: 14px; font-weight: 700;
  cursor: pointer; transition: all 0.2s;
}
.btn-hapus-data:hover { background: #fef2f2; }
[data-theme="dark"] .btn-hapus-data:hover { background: #1a0000; }

/* ADMIN LOGIN LINK */
.admin-link {
  text-align: center; margin-top: 16px;
}
.admin-link button {
  background: none; border: none; color: var(--text-muted);
  font-size: 12px; font-weight: 600; cursor: pointer;
  text-decoration: underline; font-family: 'Nunito', sans-serif;
  transition: color 0.2s;
}
.admin-link button:hover { color: var(--purple); }

/* WINDOW RESIZE WARNING */
.resize-warning {
  position: fixed; top: 0; left: 0; right: 0; z-index: 8000;
  background: linear-gradient(135deg, #d97706, #b45309);
  color: white; text-align: center;
  padding: 10px 16px; font-size: 13px; font-weight: 700;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  transform: translateY(-100%); transition: transform 0.3s ease;
  box-shadow: 0 4px 20px rgba(180,83,9,0.5);
}
.resize-warning.show { transform: translateY(0); }

/* FULLSCREEN WARNING BAR */
.fullscreen-bar {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 8500;
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  color: white; padding: 12px 20px;
  display: flex; align-items: center; justify-content: space-between;
  gap: 12px; flex-wrap: wrap;
  transform: translateY(100%); transition: transform 0.4s ease;
  box-shadow: 0 -4px 20px rgba(220,38,38,0.5);
}
.fullscreen-bar.show { transform: translateY(0); }
.fullscreen-bar p { font-size: 13px; font-weight: 700; flex: 1; }
.btn-fs {
  padding: 8px 20px; border-radius: 10px;
  background: white; color: #dc2626;
  border: none; font-family: 'Nunito', sans-serif;
  font-size: 13px; font-weight: 800; cursor: pointer; white-space: nowrap;
  transition: all 0.2s;
}
.btn-fs:hover { background: #fef2f2; transform: scale(1.03); }

/* SOAL BELUM DIJAWAB */
.question-card.unanswered-alert {
  border-color: var(--red) !important;
  background: #fef2f2 !important;
  box-shadow: 0 0 0 3px rgba(239,68,68,0.2) !important;
  animation: shakeCard 0.4s ease;
}
[data-theme="dark"] .question-card.unanswered-alert { background: #1a0000 !important; }
@keyframes shakeCard {
  0%,100%{transform:translateX(0);}
  20%{transform:translateX(-6px);}
  40%{transform:translateX(6px);}
  60%{transform:translateX(-4px);}
  80%{transform:translateX(4px);}
}
.unanswered-tag {
  display: inline-block;
  background: var(--red); color: white;
  font-size: 10px; font-weight: 800;
  padding: 2px 10px; border-radius: 20px;
  letter-spacing: 0.5px; margin-bottom: 6px;
}

/* MODAL SOAL BELUM LENGKAP */
.incomplete-list {
  background: var(--section-bg); border-radius: 12px;
  padding: 12px 16px; margin: 12px 0; text-align: left;
  max-height: 160px; overflow-y: auto;
}
.incomplete-item {
  font-size: 13px; font-weight: 600; color: var(--red);
  padding: 3px 0; display: flex; align-items: center; gap: 6px;
}
.incomplete-item::before { content: '‚Ä¢'; font-size: 18px; }

/* JADWAL UJIAN PAGE */
.jadwal-page {
  text-align: center; padding: 10px 0;
}
.jadwal-icon { font-size: 64px; margin-bottom: 16px; display: block; }
.jadwal-page h2 {
  font-family: 'Baloo 2', sans-serif; font-size: 24px;
  font-weight: 800; color: var(--text-primary); margin-bottom: 8px;
}
.jadwal-page p { color: var(--text-secondary); font-size: 14px; line-height: 1.6; }
.jadwal-info {
  background: var(--section-bg); border-radius: 14px;
  padding: 16px 20px; margin: 20px 0; text-align: left;
}
.jadwal-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 8px 0; border-bottom: 1px solid var(--divider);
  font-size: 14px;
}
.jadwal-row:last-child { border-bottom: none; }
.jadwal-row .jlabel { color: var(--text-secondary); font-weight: 600; }
.jadwal-row .jval { font-weight: 800; color: var(--text-primary); }
.countdown-box {
  background: linear-gradient(135deg, var(--navy), var(--blue));
  border-radius: 16px; padding: 20px; color: white; margin: 16px 0;
}
.countdown-label { font-size: 12px; font-weight: 700; color: var(--sky); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; }
.countdown-time {
  font-family: 'Baloo 2', sans-serif; font-size: 42px; font-weight: 800;
  letter-spacing: 2px; line-height: 1;
}
.countdown-sub { font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 6px; }
.status-badge-jadwal {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 6px 18px; border-radius: 20px;
  font-size: 13px; font-weight: 800; margin: 12px auto;
}
.status-badge-jadwal.open { background: #dcfce7; color: #16a34a; }
.status-badge-jadwal.closed { background: #fee2e2; color: #dc2626; }
.status-badge-jadwal.upcoming { background: #fef9c3; color: #a16207; }
[data-theme="dark"] .status-badge-jadwal.open { background: #052e16; color: #4ade80; }
[data-theme="dark"] .status-badge-jadwal.closed { background: #1a0000; color: #f87171; }
[data-theme="dark"] .status-badge-jadwal.upcoming { background: #1a1200; color: #fde047; }

/* ADMIN JADWAL SETTING */
.jadwal-setting {
  background: var(--section-bg); border-radius: 14px;
  padding: 16px 18px; margin-bottom: 16px;
}
.jadwal-setting h4 {
  font-size: 14px; font-weight: 800; color: var(--text-primary);
  margin-bottom: 14px; display: flex; align-items: center; gap: 6px;
}
.jadwal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.jadwal-field label {
  font-size: 12px; font-weight: 700; color: var(--text-secondary); margin-bottom: 5px;
}
.jadwal-field input {
  width: 100%; padding: 9px 12px;
  border: 2px solid var(--option-border); border-radius: 10px;
  font-family: 'Nunito', sans-serif; font-size: 14px; font-weight: 700;
  color: var(--text-primary); background: var(--option-bg); outline: none;
  transition: all 0.2s;
}
.jadwal-field input:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
.btn-simpan-jadwal {
  width: 100%; padding: 11px; margin-top: 12px;
  background: linear-gradient(135deg, var(--blue), var(--sky));
  color: white; border: none; border-radius: 10px;
  font-family: 'Nunito', sans-serif; font-size: 14px; font-weight: 800;
  cursor: pointer; transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(37,99,235,0.3);
}
.btn-simpan-jadwal:hover { transform: translateY(-1px); }

/* SOAL EDITOR */
.soal-editor {
  background: var(--section-bg); border-radius: 14px;
  padding: 16px 18px; margin-top: 20px;
}
.soal-editor h4 {
  font-size: 14px; font-weight: 800; color: var(--text-primary);
  margin-bottom: 14px; display: flex; align-items: center; gap: 6px;
}
.soal-tabs {
  display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap;
}
.soal-tab {
  padding: 6px 16px; border-radius: 20px;
  border: 2px solid var(--option-border);
  background: var(--option-bg); color: var(--text-secondary);
  font-family: 'Nunito', sans-serif; font-size: 12px; font-weight: 700;
  cursor: pointer; transition: all 0.2s;
}
.soal-tab.active { border-color: var(--blue); background: #eff6ff; color: var(--blue); }
[data-theme="dark"] .soal-tab.active { background: #0c1a2e; }

.soal-item {
  background: var(--card-bg); border-radius: 12px;
  padding: 14px 16px; margin-bottom: 12px;
  border: 2px solid var(--option-border);
  transition: border-color 0.2s;
}
.soal-item:hover { border-color: var(--sky); }
.soal-item-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 10px;
}
.soal-item-num {
  font-size: 12px; font-weight: 800; color: var(--blue);
  text-transform: uppercase; letter-spacing: 1px;
}
.soal-input {
  width: 100%; padding: 9px 12px; margin-bottom: 8px;
  border: 2px solid var(--option-border); border-radius: 10px;
  font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 600;
  color: var(--text-primary); background: var(--input-bg);
  outline: none; transition: all 0.2s; resize: vertical;
}
.soal-input:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
.opsi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
.opsi-wrap { display: flex; align-items: center; gap: 6px; }
.opsi-label {
  font-size: 11px; font-weight: 800; color: var(--text-muted);
  width: 20px; flex-shrink: 0;
}
.jawaban-select {
  width: 100%; padding: 8px 12px;
  border: 2px solid var(--green); border-radius: 10px;
  font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 700;
  color: var(--text-primary); background: var(--input-bg);
  outline: none; cursor: pointer;
}
.btn-simpan-soal {
  width: 100%; padding: 13px; margin-top: 4px;
  background: linear-gradient(135deg, #16a34a, #22c55e);
  color: white; border: none; border-radius: 12px;
  font-family: 'Nunito', sans-serif; font-size: 15px; font-weight: 800;
  cursor: pointer; transition: all 0.2s;
  box-shadow: 0 4px 16px rgba(34,197,94,0.35);
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-simpan-soal:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(34,197,94,0.4); }
.btn-simpan-soal:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
.firebase-status {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px; border-radius: 10px; margin-bottom: 14px;
  font-size: 12px; font-weight: 700;
}
.firebase-status.online { background: #dcfce7; color: #16a34a; }
.firebase-status.offline { background: #fee2e2; color: #dc2626; }
.firebase-status.loading { background: #fef9c3; color: #a16207; }
[data-theme="dark"] .firebase-status.online { background: #052e16; color: #4ade80; }
[data-theme="dark"] .firebase-status.offline { background: #1a0000; color: #f87171; }
[data-theme="dark"] .firebase-status.loading { background: #1a1200; color: #fde047; }
.soal-loading {
  text-align: center; padding: 30px;
  color: var(--text-muted); font-size: 13px; font-weight: 600;
}

.hidden { display: none !important; }

@media (max-width: 500px) {
  .card { padding: 22px 16px; }
  .nilai-num { font-size: 60px; }
  .dark-toggle { top: 10px; right: 10px; padding: 6px 12px; font-size: 12px; }
}
</style>
</head>
<body>

<!-- WATERMARK LAYER -->
<div class="watermark-layer" id="watermarkLayer"></div>

<!-- DARK MODE TOGGLE -->
<button class="dark-toggle" onclick="toggleDark()" id="darkBtn">üåô Mode Gelap</button>

<!-- FLOATING SHAPES -->
<div class="floating-shapes">
  <div class="shape">üì¶</div>
  <div class="shape">üìê</div>
  <div class="shape">üé≤</div>
  <div class="shape">üî¢</div>
  <div class="shape">üìä</div>
  <div class="shape">‚¨°</div>
</div>

<!-- SCREEN BLOCK (Tab Switch Warning) -->
<div id="screenBlock" class="screen-block hidden">
  <div class="screen-block-content">
    <div class="screen-block-icon">üö´</div>
    <h2>Peringatan Kecurangan!</h2>
    <p id="blockViolationType" style="color:#fca5a5; font-weight:700; font-size:14px; margin-bottom:8px;">‚ö†Ô∏è Terdeteksi aktivitas mencurigakan!</p>
    <p>Aktivitas ini dicatat sebagai pelanggaran ujian.</p>
    <div class="warning-count" id="blockWarningText">Pelanggaran ke-1 dari 3</div>
    <p style="font-size:13px; color:#ef4444; font-weight:700; margin-bottom:20px;">‚ö†Ô∏è Setelah 3 pelanggaran, ujian akan otomatis diserahkan!</p>
    <button class="btn-kembali-ujian" onclick="kembaliKeUjian()">‚úÖ Saya Mengerti, Kembali ke Ujian</button>
  </div>
</div>

<!-- RESIZE WARNING BAR -->
<div class="resize-warning" id="resizeWarning">
  ‚ö†Ô∏è Layar mengecil terdeteksi! Kemungkinan ada aplikasi mengambang. Ini dicatat sebagai pelanggaran!
</div>

<!-- FULLSCREEN WARNING BAR -->
<div class="fullscreen-bar" id="fullscreenBar">
  <p>üñ•Ô∏è Mode Fullscreen diperlukan selama ujian berlangsung! Tekan tombol di samping untuk kembali fullscreen.</p>
  <button class="btn-fs" onclick="masukFullscreen()">‚õ∂ Fullscreen</button>
</div>

<!-- MODAL SOAL BELUM LENGKAP -->
<div id="modalIncomplete" class="modal-overlay hidden">
  <div class="modal-box danger">
    <div class="modal-icon">‚ö†Ô∏è</div>
    <h3>Ada Soal yang Belum Dijawab!</h3>
    <p>Soal berikut belum dijawab:</p>
    <div class="incomplete-list" id="incompleteList"></div>
    <p style="font-size:13px; color:var(--text-secondary); margin-bottom:16px;">Silakan kerjakan dulu sebelum mengirim ujian.</p>
    <button class="btn-dismiss" onclick="tutupModalIncomplete()" style="background:linear-gradient(135deg,var(--blue),var(--sky));">
      üìù Kembali & Lengkapi Jawaban
    </button>
  </div>
</div>

<div class="container">
  <!-- SCHOOL HEADER -->
  <div class="school-header">
    <div class="logo-area">
      <div class="school-logo">üè´</div>
      <h1>UPT SDN BAKALAN<span>Ujian Matematika ¬∑ Kelas 6</span></h1>
    </div>
  </div>

  <!-- ===== JADWAL PAGE ===== -->
  <div id="jadwalPage" class="card card-enter hidden">
    <div class="jadwal-page">
      <span class="jadwal-icon" id="jadwalIcon">‚è∞</span>
      <h2 id="jadwalTitle">Memeriksa Jadwal...</h2>
      <p id="jadwalDesc">Harap tunggu sebentar.</p>
      <div class="status-badge-jadwal" id="jadwalBadge" style="display:none;"></div>
      <div class="jadwal-info" id="jadwalInfo" style="display:none;">
        <div class="jadwal-row">
          <span class="jlabel">üìÖ Tanggal Ujian</span>
          <span class="jval" id="jadwalTanggalTampil">-</span>
        </div>
        <div class="jadwal-row">
          <span class="jlabel">üïê Waktu Mulai</span>
          <span class="jval" id="jadwalMulaiTampil">-</span>
        </div>
        <div class="jadwal-row">
          <span class="jlabel">üïî Waktu Selesai</span>
          <span class="jval" id="jadwalSelesaiTampil">-</span>
        </div>
      </div>
      <div class="countdown-box" id="countdownBox" style="display:none;">
        <div class="countdown-label" id="countdownLabel">UJIAN DIMULAI DALAM</div>
        <div class="countdown-time" id="countdownTime">00:00:00</div>
        <div class="countdown-sub" id="countdownSub">Harap tunggu hingga ujian dibuka</div>
      </div>
    </div>
  </div>

  <!-- ===== LOGIN PAGE ===== -->
  <div id="loginPage" class="card card-enter hidden">
    <div style="text-align:center; margin-bottom:18px;">
      <span class="badge-mat">üìê MATEMATIKA ¬∑ KUBUS, BALOK & PELUANG</span>
    </div>
    <h2 class="login-title">Selamat Datang, Peserta! üëã</h2>
    <p class="login-subtitle">Isi data diri Anda dengan benar sebelum memulai ujian</p>

    <div class="form-group">
      <label for="nama">üë§ Nama Lengkap Peserta</label>
      <input type="text" id="nama" placeholder="Contoh: Budi Santoso..." />
    </div>
    <div class="form-group">
      <label for="kelas">üè´ Pilih Kelas</label>
      <select id="kelas">
        <option value="">-- Pilih Kelas --</option>
        <option value="6A">Kelas 6A</option>
        <option value="6B">Kelas 6B</option>
      </select>
    </div>

    <button class="btn-start" onclick="mulaiUjian()">üöÄ Mulai Ujian Sekarang</button>

    <div class="info-cards">
      <div class="info-card"><div class="num">10</div><div class="lbl">Pilihan Ganda</div></div>
      <div class="info-card"><div class="num">10</div><div class="lbl">Benar / Salah</div></div>
      <div class="info-card"><div class="num">5</div><div class="lbl">Isian</div></div>
    </div>

    <div class="rules-box">
      <h4>‚ö†Ô∏è Peraturan Ujian</h4>
      <ul>
        <li>üîí Dilarang berpindah tab atau jendela browser</li>
        <li>üö´ Dilarang menyalin atau mengambil tangkapan layar</li>
        <li>üìµ Matikan notifikasi selama ujian berlangsung</li>
        <li>üì± Dilarang membuka aplikasi mengambang (floating)</li>
        <li>üñ•Ô∏è Ujian harus dalam mode fullscreen</li>
        <li>üî¢ Semua soal wajib dijawab sebelum Konfirmasi</li>
        <li>‚è± Pelanggaran 3x = ujian otomatis diserahkan</li>
      </ul>
    </div>

    <div class="admin-link">
      <button onclick="bukaAdminLogin()">üîê Login sebagai Guru</button>
    </div>
  </div>

  <!-- ===== ADMIN LOGIN PAGE ===== -->
  <div id="adminLoginPage" class="card card-enter hidden">
    <div style="text-align:center; margin-bottom:16px;">
      <span class="admin-badge">üîê HALAMAN KHUSUS GURU</span>
    </div>
    <div class="admin-login-icon">üë©‚Äçüè´</div>
    <h2 class="login-title">Login Guru</h2>
    <p class="login-subtitle">Masukkan password untuk mengakses rekap nilai murid</p>

    <div class="form-group">
      <label for="adminPass">üîë Password Guru</label>
      <input type="password" id="adminPass" placeholder="Masukkan password..." onkeydown="if(event.key==='Enter') loginAdmin()" />
    </div>
    <button class="btn-admin-login" onclick="loginAdmin()">üîì Masuk ke Dashboard Guru</button>
    <button class="btn-back-login" onclick="kembaliKeLogin()">‚Üê Kembali ke Halaman Murid</button>
  </div>

  <!-- ===== ADMIN DASHBOARD ===== -->
  <div id="adminPage" class="card card-enter hidden">
    <div class="admin-topbar">
      <div>
        <h2>üìä Dashboard Guru</h2>
        <p>Rekap Nilai Ujian Matematika Kelas 6</p>
      </div>
      <button class="btn-admin-logout" onclick="logoutAdmin()">üö™ Keluar</button>
    </div>

    <div class="admin-stats">
      <div class="admin-stat">
        <div class="as-num" id="adminTotalMurid">0</div>
        <div class="as-lbl">üë§ Total Peserta</div>
      </div>
      <div class="admin-stat">
        <div class="as-num" id="adminRataRata">-</div>
        <div class="as-lbl">üìä Rata-rata Nilai</div>
      </div>
      <div class="admin-stat">
        <div class="as-num" id="adminTertinggi">-</div>
        <div class="as-lbl">üèÜ Nilai Tertinggi</div>
      </div>
    </div>

    <div class="filter-bar">
      <button class="filter-btn active" onclick="filterAdmin('semua', this)">Semua Kelas</button>
      <button class="filter-btn" onclick="filterAdmin('6A', this)">Kelas 6A</button>
      <button class="filter-btn" onclick="filterAdmin('6B', this)">Kelas 6B</button>
    </div>

    <div style="overflow-x:auto;">
      <table class="rekap-table">
        <thead>
          <tr>
            <th>No</th>
            <th>Nama</th>
            <th>Kelas</th>
            <th>Kode Sesi</th>
            <th>PG</th>
            <th>B/S</th>
            <th>Isian</th>
            <th>Jawaban Isian</th>
            <th>Nilai</th>
            <th>Pelanggaran</th>
            <th>Mulai</th>
            <th>Selesai</th>
            <th>Durasi</th>
          </tr>
        </thead>
        <tbody id="adminTableBody"></tbody>
      </table>
    </div>

    <div id="noDataMsg" class="no-data hidden">
      <span>üì≠</span>
      Belum ada murid yang mengumpulkan ujian.
    </div>

    <button class="btn-hapus-data" onclick="hapusSemuaData()">üóëÔ∏è Hapus Semua Data Rekap</button>

    <!-- JADWAL SETTING -->
    <div class="jadwal-setting" style="margin-top:20px;">
      <h4>‚è∞ Pengaturan Jadwal Ujian</h4>
      <div class="jadwal-grid">
        <div class="jadwal-field">
          <label>üìÖ Tanggal Mulai</label>
          <input type="date" id="jadwalTanggal" />
        </div>
        <div class="jadwal-field">
          <label>üìÖ Tanggal Selesai</label>
          <input type="date" id="jadwalTanggalEnd" />
        </div>
        <div class="jadwal-field">
          <label>üïê Jam Mulai</label>
          <input type="time" id="jadwalMulai" />
        </div>
        <div class="jadwal-field">
          <label>üïî Jam Selesai</label>
          <input type="time" id="jadwalSelesai" />
        </div>
      </div>
      <button class="btn-simpan-jadwal" onclick="simpanJadwal()">üíæ Simpan Jadwal Ujian</button>
      <button class="btn-hapus-data" style="margin-top:8px;" onclick="hapusJadwal()">üóëÔ∏è Hapus Jadwal (Buka Selalu)</button>
    </div>

    <!-- CUSTOM SOAL EDITOR -->
    <div class="soal-editor">
      <h4>üìù Custom Soal Ujian</h4>

      <div class="firebase-status loading" id="fbStatus">
        ‚è≥ Menghubungkan ke database...
      </div>

      <div class="soal-tabs">
        <button class="soal-tab active" onclick="gantiBagianSoal('pg', this)">üìã Pilihan Ganda (10)</button>
        <button class="soal-tab" onclick="gantiBagianSoal('bs', this)">‚úÖ Benar/Salah (10)</button>
        <button class="soal-tab" onclick="gantiBagianSoal('is', this)">‚úèÔ∏è Isian (5)</button>
      </div>

      <div id="soalEditorContent">
        <div class="soal-loading">‚è≥ Memuat soal dari database...</div>
      </div>

      <button class="btn-simpan-soal" id="btnSimpanSoal" onclick="simpanSoalKeFirebase()" disabled>
        ‚òÅÔ∏è Simpan & Update Soal ke Semua Perangkat
      </button>
    </div>
  </div>

  <!-- ===== EXAM PAGE ===== -->
  <div id="examPage" class="hidden">
    <!-- Security Bar -->
    <div class="security-bar safe" id="securityBar">
      <div class="sec-left">
        <span>üõ°Ô∏è</span>
        <span>Mode Aman Aktif</span>
        <span class="sec-badge">TERLINDUNGI</span>
      </div>
      <div class="violation-count" id="secViolationText">0 / 3 pelanggaran</div>
    </div>

    <div class="card card-enter">
      <div class="exam-header">
        <div class="exam-info">
          <h2>üìù Lembar Ujian</h2>
          <p id="examSubInfo">Nama ¬∑ Kelas</p>
          <p style="font-size:11px;color:var(--text-muted);font-weight:700;margin-top:2px;">Kode Sesi: <span id="kodeUnikExam">-</span></p>
        </div>
        <div class="progress-wrap">
          <div class="progress-text" id="progressText">0 / 25 dijawab</div>
          <div class="progress-bar-bg">
            <div class="progress-bar-fill" id="progressFill" style="width:0%"></div>
          </div>
          <div class="progress-pct" id="progressPct">0%</div>
        </div>
      </div>

      <!-- Navigator -->
      <div class="soal-nav">
        <div class="soal-nav-title">üìç Navigasi Soal (‚óè = sudah dijawab)</div>
        <div id="navDots"></div>
      </div>

      <!-- BAGIAN A -->
      <div class="section-title">
        <span class="section-badge">üìã BAGIAN A ‚Äî Pilihan Ganda</span>
        <div class="section-line"></div>
      </div>
      <p class="section-desc">Pilih satu jawaban yang paling tepat!</p>
      <div id="pgContainer"></div>

      <!-- BAGIAN B -->
      <div class="section-title">
        <span class="section-badge">‚úÖ BAGIAN B ‚Äî Benar / Salah</span>
        <div class="section-line"></div>
      </div>
      <p class="section-desc">Tentukan apakah pernyataan berikut Benar atau Salah!</p>
      <div id="bsContainer"></div>

      <!-- BAGIAN C -->
      <div class="section-title">
        <span class="section-badge">‚úèÔ∏è BAGIAN C ‚Äî Isian</span>
        <div class="section-line"></div>
      </div>
      <p class="section-desc">Jawab pertanyaan berikut dengan tepat dan singkat!</p>
      <div id="isianContainer"></div>

      <div class="bottom-bar">
        <button class="submit-btn" onclick="konfirmasi()">üì® Konfirmasi & Kirim Jawaban</button>
      </div>
    </div>
  </div>

  <!-- ===== HASIL PAGE ===== -->
  <div id="hasilPage" class="card card-enter hidden">
    <div class="hasil-header">
      <span class="hasil-icon" id="hasilIcon">üéâ</span>
      <h2 id="hasilTitle">Ujian Selesai!</h2>
      <p class="peserta-name" id="hasilPeserta"></p>
    </div>

    <div class="nilai-box">
      <div class="nilai-label">NILAI AKHIR</div>
      <div class="nilai-num" id="nilaiNum">0</div>
      <div class="nilai-predikat" id="nilaiPredikat"></div>
      <div style="margin-top:10px; font-size:11px; color:rgba(255,255,255,0.5); font-weight:700; letter-spacing:1px;">
        Kode Sesi: <span id="kodeUnikHasil" style="color:rgba(255,255,255,0.8);">-</span>
      </div>
    </div>

    <div id="violationResult"></div>

    <div class="stats-grid">
      <div class="stat-card total"><div class="s-num">25</div><div class="s-lbl">üìã Total Soal</div></div>
      <div class="stat-card benar"><div class="s-num" id="jmlBenar">0</div><div class="s-lbl">‚úÖ Benar</div></div>
      <div class="stat-card salah"><div class="s-num" id="jmlSalah">0</div><div class="s-lbl">‚ùå Salah</div></div>
    </div>

    <div class="section-stat">
      <div class="section-stat-title"><span>üìã Pilihan Ganda</span><span id="statPg">0/10</span></div>
      <div class="mini-bar-wrap"><div class="mini-bar-fill pg" id="barPg" style="width:0%"></div></div>
    </div>
    <div class="section-stat">
      <div class="section-stat-title"><span>‚úÖ Benar / Salah</span><span id="statBs">0/10</span></div>
      <div class="mini-bar-wrap"><div class="mini-bar-fill bs" id="barBs" style="width:0%"></div></div>
    </div>
    <div class="section-stat">
      <div class="section-stat-title"><span>‚úèÔ∏è Isian</span><span id="statIs">0/5</span></div>
      <div class="mini-bar-wrap"><div class="mini-bar-fill is" id="barIs" style="width:0%"></div></div>
    </div>

    <button class="btn-ulang" onclick="ulangUjian()">üîÑ Kembali ke Halaman Awal</button>
    <button class="btn-ulang" onclick="bukaAdminLogin()" style="background:linear-gradient(135deg,#7c3aed,#a855f7);margin-top:8px;">üîê Login sebagai Guru</button>
  </div>
</div>

<!-- MODAL KONFIRMASI -->
<div id="modalKonfirmasi" class="modal-overlay hidden">
  <div class="modal-box">
    <div class="modal-icon">ü§î</div>
    <h3>Apakah Anda Yakin Ingin Mengirimkan Ujiannya?</h3>
    <p>Pastikan semua soal telah Anda jawab dengan benar. Jawaban yang sudah dikirim <strong>tidak dapat diubah</strong>.</p>
    <div class="modal-btns">
      <button class="btn-cek" onclick="tutupModal()">üîç Cek Lagi</button>
      <button class="btn-iya" onclick="kirimJawaban()">‚úÖ Iya, Kirim!</button>
    </div>
  </div>
</div>

<!-- MODAL PERINGATAN KEAMANAN -->
<div id="modalSecurity" class="modal-overlay hidden">
  <div class="modal-box danger">
    <div class="modal-icon">üö®</div>
    <h3 id="secModalTitle">Peringatan Keamanan!</h3>
    <p id="secModalDesc">Terdeteksi aktivitas mencurigakan.</p>
    <button class="btn-dismiss" onclick="tutupModalSecurity()">Saya Mengerti ‚úì</button>
  </div>
</div>

<script>
/* ============================================================
   DATA SOAL
============================================================ */
const soalPG = [
  { soal:"Sebuah kubus memiliki panjang rusuk 5 cm. Berapa volume kubus tersebut?", opsi:["100 cm¬≥","125 cm¬≥","150 cm¬≥","175 cm¬≥"], jawaban:1 },
  { soal:"Sebuah balok memiliki panjang 10 cm, lebar 4 cm, dan tinggi 5 cm. Berapa volume balok tersebut?", opsi:["150 cm¬≥","180 cm¬≥","200 cm¬≥","220 cm¬≥"], jawaban:2 },
  { soal:"Luas permukaan kubus dengan rusuk 6 cm adalah...", opsi:["180 cm¬≤","210 cm¬≤","216 cm¬≤","240 cm¬≤"], jawaban:2 },
  { soal:"Sebuah balok memiliki panjang 8 cm, lebar 5 cm, dan tinggi 3 cm. Luas permukaan balok adalah...", opsi:["158 cm¬≤","152 cm¬≤","160 cm¬≤","148 cm¬≤"], jawaban:0 },
  { soal:"Sebuah dadu dilempar sekali. Peluang muncul angka 4 adalah...", opsi:["1/4","1/6","1/3","1/2"], jawaban:1 },
  { soal:"Dalam sebuah kantong terdapat 3 bola merah, 2 bola biru, dan 5 bola hijau. Peluang terambil bola merah adalah...", opsi:["1/5","2/5","3/10","3/5"], jawaban:2 },
  { soal:"Sebuah kubus memiliki luas permukaan 150 cm¬≤. Berapa panjang rusuknya?", opsi:["4 cm","5 cm","6 cm","7 cm"], jawaban:1 },
  { soal:"Volume balok = 240 cm¬≥. Jika panjang = 10 cm dan lebar = 4 cm, berapa tingginya?", opsi:["5 cm","6 cm","7 cm","8 cm"], jawaban:1 },
  { soal:"Sebuah koin dilempar sekali. Peluang muncul sisi ANGKA adalah...", opsi:["0","1/4","1/2","1"], jawaban:2 },
  { soal:"Suatu kotak berisi 10 bola bernomor 1‚Äì10. Peluang terambil bilangan genap adalah...", opsi:["2/5","3/5","1/2","3/10"], jawaban:2 }
];

const soalBS = [
  { soal:"Volume kubus dengan rusuk 4 cm adalah 64 cm¬≥.", jawaban:true },
  { soal:"Luas permukaan kubus dihitung dengan rumus 4 √ó s¬≤.", jawaban:false },
  { soal:"Balok memiliki 12 rusuk yang sama panjang.", jawaban:false },
  { soal:"Peluang suatu kejadian pasti bernilai 1.", jawaban:true },
  { soal:"Peluang suatu kejadian mustahil bernilai 0.", jawaban:true },
  { soal:"Luas permukaan balok = 2(pl + pt + lt).", jawaban:true },
  { soal:"Volume balok = panjang √ó lebar √ó tinggi.", jawaban:true },
  { soal:"Kubus adalah balok yang semua sisinya sama panjang.", jawaban:true },
  { soal:"Nilai peluang bisa lebih dari 1 jika ada kejadian yang pasti.", jawaban:false },
  { soal:"Jika peluang hujan adalah 0,7 maka peluang tidak hujan adalah 0,4.", jawaban:false }
];

const soalIsian = [
  { soal:"Sebuah kubus memiliki rusuk 9 cm. Volume kubus tersebut adalah ... cm¬≥.", jawaban:"729" },
  { soal:"Sebuah balok berukuran panjang 12 cm, lebar 5 cm, dan tinggi 4 cm. Luas permukaan balok adalah ... cm¬≤.", jawaban:"256" },
  { soal:"Dalam sebuah percobaan, peluang muncul sisi merah adalah 2/8. Bentuk paling sederhana dari peluang tersebut adalah ...", jawaban:"1/4" },
  { soal:"Sebuah kubus memiliki volume 343 cm¬≥. Panjang rusuk kubus tersebut adalah ... cm.", jawaban:"7" },
  { soal:"Sebuah dadu dilambungkan satu kali. Peluang muncul angka kurang dari 3 adalah ...", jawaban:"1/3" }
];

/* ============================================================
   STATE
============================================================ */
let namaUser='', kelasUser='', kodeUnikSesi='';
let waktuMulaiUjian = null;
let waktuMulaiStr = '';
let jawabanPG = new Array(10).fill(null);
let jawabanBS = new Array(10).fill(null);
let jawabanIsian = new Array(5).fill('');
let violationCount = 0;
const MAX_VIOLATIONS = 3;
let examActive = false;
let darkMode = false;

/* ============================================================
   DARK MODE
============================================================ */
function toggleDark() {
  darkMode = !darkMode;
  document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
  document.getElementById('darkBtn').textContent = darkMode ? '‚òÄÔ∏è Mode Terang' : 'üåô Mode Gelap';
}

/* ============================================================
   SECURITY SYSTEM
============================================================ */

let lastViolationTime = 0;
let appResumeTime = 0;

// ‚úÖ 1. Deteksi pindah tab, layar mati, app ke background (SEMUA device)
document.addEventListener('visibilitychange', () => {
  if (!examActive) return;
  if (document.hidden) {
    appResumeTime = Date.now();
    recordViolation('hidden');
  } else {
    appResumeTime = 0;
  }
});

// ‚úÖ 2. Deteksi window blur ‚Äî desktop & notifikasi HP
window.addEventListener('blur', () => {
  if (!examActive) return;
  recordViolation('blur');
});

// ‚úÖ 3. Page Lifecycle API ‚Äî freeze = layar HP dimatikan/dikunci
if ('onfreeze' in document) {
  document.addEventListener('freeze', () => {
    if (!examActive) return;
    recordViolation('freeze');
  });
}

// ‚úÖ 4. pagehide ‚Äî app di-minimize / pindah app di HP
window.addEventListener('pagehide', () => {
  if (!examActive) return;
  recordViolation('pagehide');
});

// ‚úÖ 5. pageshow persisted ‚Äî kembali dari bfcache/background
window.addEventListener('pageshow', (e) => {
  if (!examActive) return;
  if (e.persisted) recordViolation('pageshow-persisted');
});

// ‚úÖ 6. Disable klik kanan
document.addEventListener('contextmenu', (e) => {
  if (examActive) {
    e.preventDefault();
    showSecurityModal('‚õî Klik Kanan Dinonaktifkan', 'Klik kanan tidak diizinkan selama ujian berlangsung.');
  }
});

// ‚úÖ 7. Disable shortcut keyboard
document.addEventListener('keydown', (e) => {
  if (!examActive) return;
  if (
    (e.ctrlKey && ['c','v','u','s','p','a'].includes(e.key.toLowerCase())) ||
    e.key === 'F12' || e.key === 'PrintScreen'
  ) {
    e.preventDefault();
    showSecurityModal('‚õî Pintasan Keyboard Diblokir', 'Menyalin, menempel, atau mengambil tangkapan layar tidak diizinkan selama ujian.');
  }
});

// ‚úÖ 8. Disable seleksi teks
document.addEventListener('selectstart', (e) => {
  if (examActive) e.preventDefault();
});

function recordViolation(type) {
  const now = Date.now();
  if (now - lastViolationTime < 2500) return; // debounce cegah double-fire
  lastViolationTime = now;

  violationCount++;
  bunyiPeringatan(); // üîî bunyi peringatan!
  updateSecurityBar();

  if (violationCount >= MAX_VIOLATIONS) {
    examActive = false;
    setTimeout(() => {
      tutupModalSecurity();
      kirimJawaban();
    }, 2000);
    showSecurityModal(
      'üö® Batas Pelanggaran Tercapai!',
      `Anda telah melakukan ${MAX_VIOLATIONS} pelanggaran. Ujian akan otomatis diserahkan sekarang!`
    );
    return;
  }

  const pesanMap = {
    'hidden':            'Terdeteksi berpindah tab atau layar HP dimatikan!',
    'blur':              'Terdeteksi berpindah ke aplikasi atau notifikasi lain!',
    'freeze':            'Terdeteksi layar HP dikunci atau dimatikan!',
    'pagehide':          'Terdeteksi aplikasi ujian dipindahkan ke background!',
    'pageshow-persisted':'Terdeteksi kembali dari luar aplikasi ujian!',
    'fullscreen':        'Terdeteksi keluar dari mode fullscreen!',
    'resize':            'Terdeteksi layar mengecil ‚Äî kemungkinan ada aplikasi mengambang!',
  };
  const pesan = pesanMap[type] || 'Terdeteksi aktivitas mencurigakan!';

  document.getElementById('screenBlock').classList.remove('hidden');
  document.getElementById('blockWarningText').textContent = `Pelanggaran ke-${violationCount} dari ${MAX_VIOLATIONS}`;
  document.getElementById('blockViolationType').textContent = `‚ö†Ô∏è ${pesan}`;
}

function kembaliKeUjian() {
  document.getElementById('screenBlock').classList.add('hidden');
}

function updateSecurityBar() {
  const bar = document.getElementById('securityBar');
  const txt = document.getElementById('secViolationText');
  txt.textContent = `${violationCount} / ${MAX_VIOLATIONS} pelanggaran`;

  if (violationCount === 0) {
    bar.className = 'security-bar safe';
    bar.querySelector('.sec-left span:first-child').textContent = 'üõ°Ô∏è';
    bar.querySelector('.sec-left span:nth-child(2)').textContent = 'Mode Aman Aktif';
    bar.querySelector('.sec-badge').textContent = 'TERLINDUNGI';
  } else if (violationCount === 1) {
    bar.className = 'security-bar';
    bar.style.background = 'linear-gradient(135deg, #d97706, #b45309)';
    bar.querySelector('.sec-left span:first-child').textContent = '‚ö†Ô∏è';
    bar.querySelector('.sec-left span:nth-child(2)').textContent = 'Terdeteksi Pelanggaran';
    bar.querySelector('.sec-badge').textContent = 'PERINGATAN';
  } else {
    bar.className = 'security-bar';
    bar.style.background = 'linear-gradient(135deg, #dc2626, #991b1b)';
    bar.querySelector('.sec-left span:first-child').textContent = 'üö®';
    bar.querySelector('.sec-left span:nth-child(2)').textContent = 'Pelanggaran Serius!';
    bar.querySelector('.sec-badge').textContent = 'BAHAYA';
  }
}

function showSecurityModal(title, desc) {
  document.getElementById('secModalTitle').textContent = title;
  document.getElementById('secModalDesc').textContent = desc;
  document.getElementById('modalSecurity').classList.remove('hidden');
}

function tutupModalSecurity() {
  document.getElementById('modalSecurity').classList.add('hidden');
}

/* ============================================================
   ACAK SOAL
============================================================ */
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

let soalPGAcak = [];
let soalBSAcak = [];
let soalIsianAcak = [];

function acakSemua() {
  const src = getSoalAktif();
  // Acak urutan soal
  soalPGAcak = shuffle(src.pg).map(s => {
    // Acak urutan pilihan jawaban PG
    const indices = [0,1,2,3];
    const shuffledIdx = shuffle(indices);
    const newOpsi = shuffledIdx.map(i => s.opsi[i]);
    const newJawaban = shuffledIdx.indexOf(s.jawaban);
    return { ...s, opsi: newOpsi, jawaban: newJawaban };
  });
  soalBSAcak = shuffle(src.bs);
  soalIsianAcak = shuffle(src.is);
}

/* ============================================================
   WATERMARK
============================================================ */
function buatWatermark(nama, kelas) {
  const layer = document.getElementById('watermarkLayer');
  layer.innerHTML = '';
  const teks = `${nama} ¬∑ Kelas ${kelas}`;
  // Isi watermark grid
  for (let i = 0; i < 60; i++) {
    const span = document.createElement('span');
    span.className = 'watermark-text';
    span.textContent = teks;
    layer.appendChild(span);
  }
  layer.classList.add('active');
}

function hapusWatermark() {
  const layer = document.getElementById('watermarkLayer');
  layer.classList.remove('active');
  layer.innerHTML = '';
}

/* ============================================================
   ANIMASI NILAI COUNT UP
============================================================ */
function animasiNilai(targetNilai) {
  const el = document.getElementById('nilaiNum');
  el.classList.remove('animating');
  el.textContent = '0';

  let current = 0;
  const duration = 1200; // ms
  const steps = 40;
  const increment = targetNilai / steps;
  const interval = duration / steps;

  const timer = setInterval(() => {
    current += increment;
    if (current >= targetNilai) {
      current = targetNilai;
      clearInterval(timer);
      // Trigger bounce animation setelah angka final
      el.classList.add('animating');
    }
    el.textContent = Math.round(current);
  }, interval);
}

/* ============================================================
   EFEK SUARA
============================================================ */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new AudioCtx();
  return audioCtx;
}

function bunyiKlik() {
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.frequency.setValueAtTime(800, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.08);
    gain.gain.setValueAtTime(0.15, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.1);
  } catch(e) {}
}

function bunyiJawab() {
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type = 'sine';
    osc.frequency.setValueAtTime(523, ctx.currentTime);        // C5
    osc.frequency.setValueAtTime(659, ctx.currentTime + 0.1);  // E5
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.25);
  } catch(e) {}
}

function bunyi2Nada(f1, f2, dur) {
  try {
    const ctx = getAudioCtx();
    [f1, f2].forEach((freq, idx) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.type = 'sine';
      osc.frequency.value = freq;
      const t = ctx.currentTime + idx * (dur / 2);
      gain.gain.setValueAtTime(0.2, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + dur / 2);
      osc.start(t); osc.stop(t + dur / 2);
    });
  } catch(e) {}
}

function bunyiFanfare() {
  try {
    const ctx = getAudioCtx();
    // Nada fanfare: C-E-G-C tinggi
    const nada = [523, 659, 784, 1047];
    const dur = 0.18;
    nada.forEach((freq, idx) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.type = 'triangle';
      osc.frequency.value = freq;
      const t = ctx.currentTime + idx * dur;
      gain.gain.setValueAtTime(0.25, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + dur);
      osc.start(t); osc.stop(t + dur + 0.05);
    });
  } catch(e) {}
}

function bunyiPeringatan() {
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(400, ctx.currentTime);
    osc.frequency.setValueAtTime(300, ctx.currentTime + 0.15);
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.3);
  } catch(e) {}
}

/* ============================================================
   KODE UNIK SESI
============================================================ */
function generateKodeUnik() {
  // Format: 3 huruf acak + 4 angka acak = mudah dibaca guru
  const huruf = 'ABCDEFGHJKLMNPQRSTUVWXYZ'; // tanpa I, O untuk menghindari salah baca
  const angka = '0123456789';
  let kode = '';
  for (let i = 0; i < 3; i++) kode += huruf[Math.floor(Math.random() * huruf.length)];
  kode += '-';
  for (let i = 0; i < 4; i++) kode += angka[Math.floor(Math.random() * angka.length)];
  return kode; // contoh: BKX-7342
}

/* ============================================================
   LOGIN
============================================================ */
function mulaiUjian() {
  namaUser = document.getElementById('nama').value.trim();
  kelasUser = document.getElementById('kelas').value;
  if (!namaUser) { alert('Masukkan nama Anda terlebih dahulu!'); return; }
  if (!kelasUser) { alert('Pilih kelas Anda terlebih dahulu!'); return; }

  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('examPage').classList.remove('hidden');
  document.getElementById('examSubInfo').textContent = `${namaUser} ¬∑ Kelas ${kelasUser}`;

  violationCount = 0;
  examActive = true;
  waktuMulaiUjian = new Date();
  waktuMulaiStr = waktuMulaiUjian.toLocaleString('id-ID');
  initialWidth = window.innerWidth;
  initialHeight = window.innerHeight;
  kodeUnikSesi = generateKodeUnik();
  document.getElementById('kodeUnikExam').textContent = kodeUnikSesi;
  masukFullscreen();
  bunyi2Nada(440, 550, 0.3);

  // Tampilkan loading sementara soal dimuat
  document.getElementById('pgContainer').innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-muted);font-weight:700;">‚è≥ Memuat soal...</div>';

  // Tunggu Firebase siap, lalu load soal
  tungguFirebaseLaluMulai(0);
}

function tungguFirebaseLaluMulai(attempt) {
  // Kalau soal sudah preloaded ATAU db sudah siap ATAU sudah 3 detik ‚Üí langsung mulai
  if (soalDariFirebase !== null || db || attempt >= 6) {
    acakSemua();
    buatWatermark(namaUser, kelasUser);
    renderSoal();
    renderNavDots();
    updateProgress();
    window.scrollTo({ top:0, behavior:'smooth' });
  } else {
    setTimeout(() => tungguFirebaseLaluMulai(attempt + 1), 500);
  }
}

/* ============================================================
   RENDER SOAL
============================================================ */
function renderSoal() {
  const pgCont = document.getElementById('pgContainer');
  pgCont.innerHTML = '';
  soalPGAcak.forEach((s, i) => {
    const div = document.createElement('div');
    div.className = 'question-card';
    div.id = `pg-card-${i}`;
    div.style.animationDelay = `${i * 0.04}s`;
    div.innerHTML = `
      <div class="question-num">Soal ${i+1} dari 10</div>
      <div class="question-text">${i+1}. ${s.soal}</div>
      <div class="options-grid">
        ${s.opsi.map((o, j) => `
          <label class="option-label" id="pg-opt-${i}-${j}" onclick="pilihPG(${i}, ${j})">
            <input type="radio" name="pg-${i}" value="${j}">
            <span class="opt-letter">${['A','B','C','D'][j]}</span>
            <span>${o}</span>
          </label>
        `).join('')}
      </div>
    `;
    pgCont.appendChild(div);
  });

  const bsCont = document.getElementById('bsContainer');
  bsCont.innerHTML = '';
  soalBSAcak.forEach((s, i) => {
    const div = document.createElement('div');
    div.className = 'question-card';
    div.id = `bs-card-${i}`;
    div.style.animationDelay = `${(i + 10) * 0.04}s`;
    div.innerHTML = `
      <div class="question-num">Soal ${i+1} dari 10</div>
      <div class="question-text">${i+1}. ${s.soal}</div>
      <div class="bs-options">
        <button class="bs-btn" id="bs-true-${i}" onclick="pilihBS(${i}, true)">‚úÖ BENAR</button>
        <button class="bs-btn" id="bs-false-${i}" onclick="pilihBS(${i}, false)">‚ùå SALAH</button>
      </div>
    `;
    bsCont.appendChild(div);
  });

  const isCont = document.getElementById('isianContainer');
  isCont.innerHTML = '';
  soalIsianAcak.forEach((s, i) => {
    const div = document.createElement('div');
    div.className = 'question-card';
    div.id = `is-card-${i}`;
    div.style.animationDelay = `${(i + 20) * 0.04}s`;
    div.innerHTML = `
      <div class="question-num">Soal ${i+1} dari 5</div>
      <div class="question-text">${i+1}. ${s.soal}</div>
      <input class="isian-input" type="text" id="isian-${i}" placeholder="Ketik jawaban Anda..." oninput="isiIsian(${i}, this.value)" />
    `;
    isCont.appendChild(div);
  });
}

function renderNavDots() {
  const cont = document.getElementById('navDots');
  cont.innerHTML = '';
  const wrapper = document.createElement('div');
  wrapper.style.cssText = 'display:flex; flex-wrap:wrap; gap:6px;';

  // PG dots
  const pgLabel = document.createElement('span');
  pgLabel.style.cssText = 'font-size:10px;font-weight:800;color:var(--text-muted);width:100%;margin-top:4px;';
  pgLabel.textContent = 'A. Pilihan Ganda:';
  wrapper.appendChild(pgLabel);

  for (let i = 0; i < 10; i++) {
    const dot = document.createElement('div');
    dot.className = 'nav-dot pg';
    dot.id = `ndot-pg-${i}`;
    dot.textContent = i + 1;
    dot.onclick = () => scrollToCard(`pg-card-${i}`);
    wrapper.appendChild(dot);
  }

  const bsLabel = document.createElement('span');
  bsLabel.style.cssText = 'font-size:10px;font-weight:800;color:var(--text-muted);width:100%;margin-top:4px;';
  bsLabel.textContent = 'B. Benar / Salah:';
  wrapper.appendChild(bsLabel);

  for (let i = 0; i < 10; i++) {
    const dot = document.createElement('div');
    dot.className = 'nav-dot bs';
    dot.id = `ndot-bs-${i}`;
    dot.textContent = i + 1;
    dot.onclick = () => scrollToCard(`bs-card-${i}`);
    wrapper.appendChild(dot);
  }

  const isLabel = document.createElement('span');
  isLabel.style.cssText = 'font-size:10px;font-weight:800;color:var(--text-muted);width:100%;margin-top:4px;';
  isLabel.textContent = 'C. Isian:';
  wrapper.appendChild(isLabel);

  for (let i = 0; i < 5; i++) {
    const dot = document.createElement('div');
    dot.className = 'nav-dot is';
    dot.id = `ndot-is-${i}`;
    dot.textContent = i + 1;
    dot.onclick = () => scrollToCard(`is-card-${i}`);
    wrapper.appendChild(dot);
  }

  cont.appendChild(wrapper);
}

function scrollToCard(id) {
  const el = document.getElementById(id);
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

/* ============================================================
   JAWABAN
============================================================ */
function pilihPG(soalIdx, optIdx) {
  bunyiKlik();
  jawabanPG[soalIdx] = optIdx;
  for (let j = 0; j < 4; j++) {
    const el = document.getElementById(`pg-opt-${soalIdx}-${j}`);
    if (el) el.classList.remove('selected');
  }
  const sel = document.getElementById(`pg-opt-${soalIdx}-${optIdx}`);
  if (sel) sel.classList.add('selected');
  markAnswered(`pg-card-${soalIdx}`, `ndot-pg-${soalIdx}`);
  bunyiJawab();
  updateProgress();
}

function pilihBS(soalIdx, jawab) {
  bunyiKlik();
  jawabanBS[soalIdx] = jawab;
  const btnTrue = document.getElementById(`bs-true-${soalIdx}`);
  const btnFalse = document.getElementById(`bs-false-${soalIdx}`);
  btnTrue.className = 'bs-btn' + (jawab === true ? ' selected-true' : '');
  btnFalse.className = 'bs-btn' + (jawab === false ? ' selected-false' : '');
  markAnswered(`bs-card-${soalIdx}`, `ndot-bs-${soalIdx}`);
  bunyiJawab();
  updateProgress();
}

function isiIsian(soalIdx, val) {
  jawabanIsian[soalIdx] = val.trim();
  if (val.trim()) {
    if (val.length === 1) bunyiKlik(); // bunyi pertama kali isi
    markAnswered(`is-card-${soalIdx}`, `ndot-is-${soalIdx}`);
    if (val.trim().length >= 1) bunyiJawab();
  } else {
    const card = document.getElementById(`is-card-${soalIdx}`);
    card.classList.remove('answered');
    card.classList.remove('unanswered-alert');
    const tag = card.querySelector('.unanswered-tag');
    if (tag) tag.remove();
    const dot = document.getElementById(`ndot-is-${soalIdx}`);
    if (dot) dot.classList.remove('done');
  }
  updateProgress();
}

function markAnswered(cardId, dotId) {
  const card = document.getElementById(cardId);
  card.classList.add('answered');
  // Hapus highlight merah jika ada
  card.classList.remove('unanswered-alert');
  const tag = card.querySelector('.unanswered-tag');
  if (tag) tag.remove();

  if (dotId) {
    const dot = document.getElementById(dotId);
    if (dot) dot.classList.add('done');
  }
}

function updateProgress() {
  const a = jawabanPG.filter(v => v !== null).length;
  const b = jawabanBS.filter(v => v !== null).length;
  const c = jawabanIsian.filter(v => v !== '').length;
  const total = a + b + c;
  const pct = Math.round((total / 25) * 100);

  document.getElementById('progressText').textContent = `${total} / 25 dijawab`;
  document.getElementById('progressFill').style.width = `${pct}%`;
  document.getElementById('progressPct').textContent = `${pct}%`;
}

/* ============================================================
   KONFIRMASI & SUBMIT
============================================================ */
function konfirmasi() {
  // Cek soal yang belum dijawab
  const belum = cekSoalBelumDijawab();
  if (belum.length > 0) {
    tampilkanModalIncomplete(belum);
    return;
  }
  document.getElementById('modalKonfirmasi').classList.remove('hidden');
}

function tutupModal() {
  document.getElementById('modalKonfirmasi').classList.add('hidden');
}

function kirimJawaban() {
  tutupModal();
  examActive = false;
  // Pulihkan examPage dulu sebelum exit fullscreen
  document.getElementById('examPage').style.pointerEvents = '';
  document.getElementById('examPage').style.opacity = '';
  // Keluar fullscreen
  if (document.exitFullscreen) document.exitFullscreen().catch(()=>{});
  else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
  document.getElementById('fullscreenBar').classList.remove('show');
  hitungHasil();
}

/* ============================================================
   HITUNG HASIL
============================================================ */
function hitungHasil() {
  let benarPG = 0, benarBS = 0, benarIs = 0;

  soalPGAcak.forEach((s, i) => { if (jawabanPG[i] === s.jawaban) benarPG++; });
  soalBSAcak.forEach((s, i) => { if (jawabanBS[i] === s.jawaban) benarBS++; });
  soalIsianAcak.forEach((s, i) => {
    const ans = jawabanIsian[i].toLowerCase().replace(/\s/g,'');
    const key = s.jawaban.toLowerCase().replace(/\s/g,'');
    if (ans === key) benarIs++;
  });

  const totalBenar = benarPG + benarBS + benarIs;
  const totalSalah = 25 - totalBenar;
  const nilai = Math.round((totalBenar / 25) * 100);

  let predikat='', icon='';
  if (nilai>=90) { predikat='üåü Sempurna! Luar Biasa!'; icon='üèÜ'; }
  else if (nilai>=80) { predikat='‚≠ê Sangat Baik!'; icon='üéâ'; }
  else if (nilai>=70) { predikat='üëç Baik!'; icon='üòä'; }
  else if (nilai>=60) { predikat='üìö Cukup, Terus Belajar!'; icon='üôÇ'; }
  else { predikat='üí™ Semangat Belajar Lebih Giat!'; icon='üò§'; }

  document.getElementById('hasilIcon').textContent = icon;
  document.getElementById('hasilPeserta').textContent = `${namaUser} ¬∑ Kelas ${kelasUser}`;
  document.getElementById('nilaiPredikat').textContent = predikat;
  document.getElementById('jmlBenar').textContent = totalBenar;
  document.getElementById('jmlSalah').textContent = totalSalah;
  document.getElementById('statPg').textContent = `${benarPG}/10`;
  document.getElementById('statBs').textContent = `${benarBS}/10`;
  document.getElementById('statIs').textContent = `${benarIs}/5`;

  // Violation notice
  const vDiv = document.getElementById('violationResult');
  if (violationCount > 0) {
    vDiv.innerHTML = `
      <div class="violation-result">
        <span class="v-icon">‚ö†Ô∏è</span>
        <span class="v-text">Tercatat ${violationCount} pelanggaran keamanan selama ujian berlangsung.</span>
      </div>`;
  } else {
    vDiv.innerHTML = '';
  }

  // Simpan rekap untuk admin & kirim email ke guru
  const waktuSelesai = new Date();
  const waktuSelesaiStr = waktuSelesai.toLocaleString('id-ID');
  const durasiMs = waktuSelesai - waktuMulaiUjian;
  const durasiMenit = Math.floor(durasiMs / 60000);
  const durasiDetik = Math.floor((durasiMs % 60000) / 1000);
  const durasiStr = `${durasiMenit}m ${durasiDetik}d`;

  // Kumpulkan jawaban isian murid
  const jawabanIsianMurid = soalIsianAcak.map((s, i) => jawabanIsian[i] || '');

  const dataRekap = {
    nama: namaUser, kelas: kelasUser,
    benarPG, benarBS, benarIs,
    totalBenar, totalSalah, nilai,
    pelanggaran: violationCount,
    waktuMulai: waktuMulaiStr,
    waktuSelesai: waktuSelesaiStr,
    durasi: durasiStr,
    waktu: waktuSelesaiStr,
    kode: kodeUnikSesi,
    jawabanIsian: jawabanIsianMurid
  };
  simpanRekapMurid(dataRekap);
  kirimEmail(dataRekap);

  // Tampilkan kode unik di halaman hasil
  document.getElementById('kodeUnikHasil').textContent = kodeUnikSesi;

  // Tampilkan halaman hasil
  sembunyikanSemua();
  document.getElementById('hasilPage').classList.remove('hidden');
  hapusWatermark();
  window.scrollTo({ top:0, behavior:'smooth' });

  // Fanfare saat hasil muncul
  setTimeout(() => bunyiFanfare(), 400);

  // Animasi nilai & bar setelah halaman muncul
  setTimeout(() => animasiNilai(nilai), 300);
  setTimeout(() => {
    document.getElementById('barPg').style.width = `${(benarPG / 10) * 100}%`;
    document.getElementById('barBs').style.width = `${(benarBS / 10) * 100}%`;
    document.getElementById('barIs').style.width = `${(benarIs / 5) * 100}%`;
  }, 500);
}

/* ============================================================
   JADWAL UJIAN
============================================================ */
let jadwalTimer = null;

function cekJadwal() {
  const raw = localStorage.getItem('jadwalUjian');
  if (!raw) {
    // Tidak ada jadwal = selalu buka
    tampilkanLogin();
    return;
  }

  const jadwal = JSON.parse(raw);
  const now = new Date();
  const mulai = new Date(`${jadwal.tanggal}T${jadwal.mulai}:00`);
  const selesai = new Date(`${jadwal.tanggalEnd}T${jadwal.selesai}:00`);

  // Update tampilan jadwal info
  document.getElementById('jadwalTanggalTampil').textContent =
    new Date(jadwal.tanggal).toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
  document.getElementById('jadwalMulaiTampil').textContent = jadwal.mulai + ' WIB';
  document.getElementById('jadwalSelesaiTampil').textContent = jadwal.selesai + ' WIB';
  document.getElementById('jadwalInfo').style.display = 'block';

  if (now < mulai) {
    // Belum waktunya
    tampilkanJadwal('upcoming', '‚è≥', 'Ujian Belum Dibuka',
      'Ujian akan dibuka sesuai jadwal. Harap tunggu dan bersiap!');
    document.getElementById('countdownBox').style.display = 'block';
    document.getElementById('countdownLabel').textContent = 'UJIAN DIMULAI DALAM';
    document.getElementById('countdownSub').textContent = 'Harap tunggu hingga ujian dibuka';
    mulaiCountdown(mulai);
  } else if (now >= mulai && now <= selesai) {
    // Waktunya ujian!
    clearInterval(jadwalTimer);
    document.getElementById('countdownBox').style.display = 'block';
    document.getElementById('countdownLabel').textContent = 'SISA WAKTU UJIAN';
    document.getElementById('countdownSub').textContent = 'Ujian sedang berlangsung';
    mulaiCountdown(selesai, true);
    tampilkanJadwal('open', '‚úÖ', 'Ujian Sedang Berlangsung!',
      'Ujian sudah dibuka. Silakan login dan mulai kerjakan soal!');
    // Auto redirect ke login setelah 2 detik
    setTimeout(() => tampilkanLogin(), 2000);
  } else {
    // Sudah lewat
    clearInterval(jadwalTimer);
    document.getElementById('countdownBox').style.display = 'none';
    tampilkanJadwal('closed', 'üîí', 'Waktu Ujian Telah Berakhir',
      'Sesi ujian sudah ditutup. Hubungi guru untuk informasi lebih lanjut.');
  }
}

function tampilkanJadwal(status, icon, title, desc) {
  sembunyikanSemua();
  document.getElementById('jadwalPage').classList.remove('hidden');
  document.getElementById('jadwalIcon').textContent = icon;
  document.getElementById('jadwalTitle').textContent = title;
  document.getElementById('jadwalDesc').textContent = desc;

  const badge = document.getElementById('jadwalBadge');
  badge.style.display = 'inline-flex';
  badge.className = `status-badge-jadwal ${status}`;
  const labels = { open:'üü¢ UJIAN TERBUKA', closed:'üî¥ UJIAN DITUTUP', upcoming:'üü° BELUM DIBUKA' };
  badge.textContent = labels[status];
}

function tampilkanLogin() {
  clearInterval(jadwalTimer);
  sembunyikanSemua();
  document.getElementById('loginPage').classList.remove('hidden');
}

function mulaiCountdown(targetDate, isEnd = false) {
  clearInterval(jadwalTimer);
  jadwalTimer = setInterval(() => {
    const now = new Date();
    const diff = targetDate - now;
    if (diff <= 0) {
      clearInterval(jadwalTimer);
      if (isEnd) {
        // Waktu ujian habis saat sedang countdown
        cekJadwal();
      } else {
        // Jadwal mulai tiba - redirect ke login
        tampilkanLogin();
      }
      return;
    }
    const h = String(Math.floor(diff / 3600000)).padStart(2,'0');
    const m = String(Math.floor((diff % 3600000) / 60000)).padStart(2,'0');
    const s = String(Math.floor((diff % 60000) / 1000)).padStart(2,'0');
    const el = document.getElementById('countdownTime');
    if (el) el.textContent = `${h}:${m}:${s}`;
  }, 1000);
}

function simpanJadwal() {
  const tanggal = document.getElementById('jadwalTanggal').value;
  const tanggalEnd = document.getElementById('jadwalTanggalEnd').value;
  const mulai = document.getElementById('jadwalMulai').value;
  const selesai = document.getElementById('jadwalSelesai').value;
  if (!tanggal || !tanggalEnd || !mulai || !selesai) {
    alert('Lengkapi semua field jadwal terlebih dahulu!'); return;
  }
  localStorage.setItem('jadwalUjian', JSON.stringify({ tanggal, tanggalEnd, mulai, selesai }));
  alert('‚úÖ Jadwal ujian berhasil disimpan!');
}

function hapusJadwal() {
  if (confirm('Hapus jadwal? Ujian akan bisa diakses kapan saja.')) {
    localStorage.removeItem('jadwalUjian');
    alert('‚úÖ Jadwal dihapus. Ujian sekarang bisa diakses kapan saja.');
  }
}

function muatJadwalKeForm() {
  const raw = localStorage.getItem('jadwalUjian');
  if (!raw) return;
  const j = JSON.parse(raw);
  document.getElementById('jadwalTanggal').value = j.tanggal || '';
  document.getElementById('jadwalTanggalEnd').value = j.tanggalEnd || '';
  document.getElementById('jadwalMulai').value = j.mulai || '';
  document.getElementById('jadwalSelesai').value = j.selesai || '';
}

/* ============================================================
   FULLSCREEN
============================================================ */
function masukFullscreen() {
  const el = document.documentElement;
  if (el.requestFullscreen) el.requestFullscreen();
  else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
  else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
}

function keluarFullscreenDetected() {
  if (!examActive) return;
  const isFs = !!(document.fullscreenElement ||
    document.webkitFullscreenElement ||
    document.mozFullScreenElement);

  if (!isFs) {
    // Tampilkan fullscreen bar DAN blokir soal
    document.getElementById('fullscreenBar').classList.add('show');
    document.getElementById('examPage').style.pointerEvents = 'none';
    document.getElementById('examPage').style.opacity = '0.4';
    recordViolation('fullscreen');
  } else {
    // Kembali fullscreen ‚Äî aktifkan kembali soal
    document.getElementById('fullscreenBar').classList.remove('show');
    document.getElementById('examPage').style.pointerEvents = '';
    document.getElementById('examPage').style.opacity = '';
  }
}

document.addEventListener('fullscreenchange', keluarFullscreenDetected);
document.addEventListener('webkitfullscreenchange', keluarFullscreenDetected);
document.addEventListener('mozfullscreenchange', keluarFullscreenDetected);

/* ============================================================
   SOAL WAJIB DIISI
============================================================ */
function cekSoalBelumDijawab() {
  const belum = [];

  jawabanPG.forEach((v, i) => {
    if (v === null) belum.push({ bagian: 'A', no: i + 1, cardId: `pg-card-${i}` });
  });
  jawabanBS.forEach((v, i) => {
    if (v === null) belum.push({ bagian: 'B', no: i + 1, cardId: `bs-card-${i}` });
  });
  jawabanIsian.forEach((v, i) => {
    if (v === '') belum.push({ bagian: 'C', no: i + 1, cardId: `is-card-${i}` });
  });

  return belum;
}

function tampilkanModalIncomplete(belumList) {
  const listEl = document.getElementById('incompleteList');
  listEl.innerHTML = '';
  belumList.forEach(item => {
    const div = document.createElement('div');
    div.className = 'incomplete-item';
    const nama = item.bagian === 'A' ? 'Pilihan Ganda' : item.bagian === 'B' ? 'Benar/Salah' : 'Isian';
    div.textContent = `Bagian ${item.bagian} (${nama}) ‚Äî Soal No. ${item.no}`;
    listEl.appendChild(div);
  });
  document.getElementById('modalIncomplete').classList.remove('hidden');
}

function tutupModalIncomplete() {
  document.getElementById('modalIncomplete').classList.add('hidden');
  const belum = cekSoalBelumDijawab();
  if (belum.length > 0) {
    // Reset semua alert dulu
    document.querySelectorAll('.question-card.unanswered-alert').forEach(c => {
      c.classList.remove('unanswered-alert');
      const tag = c.querySelector('.unanswered-tag');
      if (tag) tag.remove();
    });
    // Tandai semua yang belum
    belum.forEach(item => {
      const card = document.getElementById(item.cardId);
      if (card) {
        card.classList.add('unanswered-alert');
        if (!card.querySelector('.unanswered-tag')) {
          const tag = document.createElement('div');
          tag.className = 'unanswered-tag';
          tag.textContent = '‚ö† BELUM DIJAWAB';
          card.prepend(tag);
        }
      }
    });
    // Scroll ke soal pertama
    scrollToCard(belum[0].cardId);
  }
}

/* ============================================================
   DETEKSI LAYAR MENGECIL (Floating Window)
============================================================ */
const ADMIN_PASSWORD = 'guru123'; // ‚Üê Ganti password di sini
let initialWidth = window.innerWidth;
let initialHeight = window.innerHeight;
let resizeWarningTimer = null;

window.addEventListener('resize', () => {
  if (!examActive) return;

  const currentW = window.innerWidth;
  const currentH = window.innerHeight;
  const shrinkW = initialWidth - currentW;
  const shrinkH = initialHeight - currentH;

  // Layar mengecil signifikan = kemungkinan floating window
  if (shrinkW > 80 || shrinkH > 80) {
    tampilkanResizeWarning();
    recordViolation('resize');
  }
});

function tampilkanResizeWarning() {
  const bar = document.getElementById('resizeWarning');
  bar.classList.add('show');
  clearTimeout(resizeWarningTimer);
  resizeWarningTimer = setTimeout(() => bar.classList.remove('show'), 4000);
}

/* ============================================================
   ADMIN SYSTEM
============================================================ */
let rekapData = [];
let filterKelas = 'semua';

function bukaAdminLogin() {
  sembunyikanSemua();
  document.getElementById('adminLoginPage').classList.remove('hidden');
  document.getElementById('adminLoginPage').classList.add('card-enter');
  setTimeout(() => document.getElementById('adminPass').focus(), 300);
}

function kembaliKeLogin() {
  sembunyikanSemua();
  document.getElementById('loginPage').classList.remove('hidden');
  document.getElementById('adminPass').value = '';
}

function loginAdmin() {
  const pass = document.getElementById('adminPass').value;
  if (pass === ADMIN_PASSWORD) {
    document.getElementById('adminPass').value = '';
    sembunyikanSemua();
    document.getElementById('adminPage').classList.remove('hidden');
    renderAdminDashboard();
  } else {
    document.getElementById('adminPass').style.borderColor = 'var(--red)';
    document.getElementById('adminPass').style.boxShadow = '0 0 0 4px rgba(239,68,68,0.15)';
    setTimeout(() => {
      document.getElementById('adminPass').style.borderColor = '';
      document.getElementById('adminPass').style.boxShadow = '';
    }, 1500);
    alert('‚ùå Password salah! Coba lagi.');
  }
}

function logoutAdmin() {
  sembunyikanSemua();
  document.getElementById('loginPage').classList.remove('hidden');
}

function sembunyikanSemua() {
  ['loginPage','adminLoginPage','adminPage','examPage','hasilPage','jadwalPage'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.add('hidden');
  });
  document.getElementById('fullscreenBar').classList.remove('show');
}

function simpanRekapMurid(data) {
  try {
    const existing = JSON.parse(localStorage.getItem('rekapUjian') || '[]');
    existing.push(data);
    localStorage.setItem('rekapUjian', JSON.stringify(existing));
    rekapData = existing;
  } catch(e) {
    rekapData.push(data);
  }
}

function muatRekap() {
  try {
    rekapData = JSON.parse(localStorage.getItem('rekapUjian') || '[]');
  } catch(e) {
    rekapData = [];
  }
}

function renderAdminDashboard() {
  muatRekap();
  muatJadwalKeForm();
  muatEditorDariFirebase();
  const filtered = filterKelas === 'semua'
    ? rekapData
    : rekapData.filter(d => d.kelas === filterKelas);

  // Stats
  document.getElementById('adminTotalMurid').textContent = filtered.length;
  if (filtered.length > 0) {
    const rata = Math.round(filtered.reduce((s, d) => s + d.nilai, 0) / filtered.length);
    const max = Math.max(...filtered.map(d => d.nilai));
    document.getElementById('adminRataRata').textContent = rata;
    document.getElementById('adminTertinggi').textContent = max;
  } else {
    document.getElementById('adminRataRata').textContent = '-';
    document.getElementById('adminTertinggi').textContent = '-';
  }

  // Table
  const tbody = document.getElementById('adminTableBody');
  tbody.innerHTML = '';

  if (filtered.length === 0) {
    document.getElementById('noDataMsg').classList.remove('hidden');
  } else {
    document.getElementById('noDataMsg').classList.add('hidden');
    filtered.forEach((d, i) => {
      const nilaiClass = d.nilai >= 90 ? 'a' : d.nilai >= 75 ? 'b' : d.nilai >= 60 ? 'c' : 'd';
      const pelColor = d.pelanggaran === 0 ? '#22c55e' : d.pelanggaran === 1 ? '#f59e0b' : '#ef4444';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td><strong>${d.nama}</strong></td>
        <td>${d.kelas}</td>
        <td style="font-family:monospace;font-size:12px;font-weight:800;color:var(--purple);">${d.kode || '-'}</td>
        <td>${d.benarPG}/10</td>
        <td>${d.benarBS}/10</td>
        <td>${d.benarIs}/5</td>
        <td style="font-size:11px;max-width:160px;">
          ${(d.jawabanIsian||[]).map((j,idx) => `<div style="margin-bottom:2px;"><span style="font-weight:800;color:var(--blue);">Is${idx+1}:</span> ${j||'<i style="color:var(--text-muted)">kosong</i>'}</div>`).join('') || '-'}
        </td>
        <td><span class="nilai-pill ${nilaiClass}">${d.nilai}</span></td>
        <td>
          <span class="pelanggaran-dot" style="background:${pelColor}"></span>
          ${d.pelanggaran}x
        </td>
        <td style="font-size:11px;color:var(--text-muted);white-space:nowrap;">${d.waktuMulai || '-'}</td>
        <td style="font-size:11px;color:var(--text-muted);white-space:nowrap;">${d.waktuSelesai || d.waktu || '-'}</td>
        <td style="font-size:11px;font-weight:800;color:var(--green);">${d.durasi || '-'}</td>
      `;
      tbody.appendChild(tr);
    });
  }
}

function filterAdmin(kelas, btn) {
  filterKelas = kelas;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderAdminDashboard();
}

function hapusSemuaData() {
  if (confirm('Yakin ingin menghapus semua data rekap ujian? Tindakan ini tidak bisa dibatalkan!')) {
    localStorage.removeItem('rekapUjian');
    rekapData = [];
    renderAdminDashboard();
  }
}

/* ============================================================
   FIREBASE ‚Äî INISIALISASI
============================================================ */
const firebaseConfig = {
  apiKey: "AIzaSyDIExUgS3n13al84KJEgQoruA-Eo5SzORw",
  authDomain: "ujian-sdn-bakalan.firebaseapp.com",
  databaseURL: "https://ujian-sdn-bakalan-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ujian-sdn-bakalan",
  storageBucket: "ujian-sdn-bakalan.firebasestorage.app",
  messagingSenderId: "1055826875799",
  appId: "1:1055826875799:web:96b451080aa26ef581a0d2"
};

let db = null;
let fbTerhubung = false;

function inisialisasiFirebase() {
  if (typeof firebase === 'undefined') {
    console.warn('Firebase belum siap, coba lagi...');
    setTimeout(inisialisasiFirebase, 500);
    return;
  }
  try {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.database();

    // Langsung pre-load soal dari Firebase begitu db siap
    muatSoalDariFirebase(() => {
      console.log('‚úÖ Soal berhasil dimuat dari Firebase');
    });

    // Monitor koneksi
    db.ref('.info/connected').on('value', snap => {
      fbTerhubung = !!snap.val();
      const el = document.getElementById('fbStatus');
      const btn = document.getElementById('btnSimpanSoal');
      if (el) {
        if (fbTerhubung) {
          el.className = 'firebase-status online';
          el.textContent = 'üü¢ Terhubung ke database ‚Äî Soal akan terupdate di semua perangkat';
          if (btn) btn.disabled = false;
        } else {
          el.className = 'firebase-status offline';
          el.textContent = 'üî¥ Tidak terhubung ‚Äî Periksa koneksi internet';
          if (btn) btn.disabled = true;
        }
      }
    });
  } catch(e) {
    console.error('Firebase error:', e);
  }
}

// Langsung inisialisasi Firebase secepat mungkin
function cobaInisialisasiFirebase(attempt) {
  if (typeof firebase !== 'undefined') {
    inisialisasiFirebase();
  } else if (attempt < 10) {
    setTimeout(() => cobaInisialisasiFirebase(attempt + 1), 100);
  }
}
cobaInisialisasiFirebase(0);

/* ============================================================
   FIREBASE ‚Äî LOAD & SIMPAN SOAL
============================================================ */
let soalDariFirebase = null; // null = pakai soal default
let bagianAktif = 'pg';
let soalEditor = { pg: null, bs: null, is: null };

// Load soal dari Firebase saat ujian dimulai
function muatSoalDariFirebase(callback) {
  if (!db) { soalDariFirebase = null; callback(); return; }
  db.ref('soal').once('value').then(snap => {
    soalDariFirebase = snap.exists() ? snap.val() : null;
    callback();
  }).catch(() => {
    soalDariFirebase = null;
    callback();
  });
}

function getSoalAktif() {
  if (!soalDariFirebase) return { pg: soalPG, bs: soalBS, is: soalIsian };
  return {
    pg: soalDariFirebase.pg || soalPG,
    bs: soalDariFirebase.bs || soalBS,
    is: soalDariFirebase.is || soalIsian
  };
}

function simpanSoalKeFirebase() {
  if (!db) { alert('‚ùå Firebase belum terhubung! Pastikan ada koneksi internet.'); return; }
  const soalBaru = bacaFormSoal();
  if (!soalBaru) return;

  const btn = document.getElementById('btnSimpanSoal');
  btn.disabled = true;
  btn.textContent = '‚è≥ Menyimpan...';

  db.ref('soal').set(soalBaru).then(() => {
    btn.textContent = '‚úÖ Berhasil Disimpan!';
    btn.style.background = 'linear-gradient(135deg, #0369a1, #0ea5e9)';
    setTimeout(() => {
      btn.textContent = '‚òÅÔ∏è Simpan & Update Soal ke Semua Perangkat';
      btn.style.background = '';
      btn.disabled = false;
    }, 2500);
    soalEditor = soalBaru;
    bunyiJawab();
  }).catch(err => {
    alert('‚ùå Gagal menyimpan: ' + err.message);
    btn.disabled = false;
    btn.textContent = '‚òÅÔ∏è Simpan & Update Soal ke Semua Perangkat';
  });
}

/* ============================================================
   SOAL EDITOR UI
============================================================ */
let bagianEditorAktif = 'pg';

function gantiBagianSoal(bagian, btn) {
  bagianEditorAktif = bagian;
  document.querySelectorAll('.soal-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderEditorSoal();
}

function renderEditorSoal() {
  const cont = document.getElementById('soalEditorContent');
  const soal = soalEditor;
  if (!soal || !soal.pg) {
    cont.innerHTML = '<div class="soal-loading">‚è≥ Memuat soal...</div>';
    return;
  }

  cont.innerHTML = '';

  if (bagianEditorAktif === 'pg') {
    soal.pg.forEach((s, i) => {
      cont.appendChild(buatCardPG(s, i));
    });
  } else if (bagianEditorAktif === 'bs') {
    soal.bs.forEach((s, i) => {
      cont.appendChild(buatCardBS(s, i));
    });
  } else {
    soal.is.forEach((s, i) => {
      cont.appendChild(buatCardIsian(s, i));
    });
  }
}

function buatCardPG(s, i) {
  const div = document.createElement('div');
  div.className = 'soal-item';
  div.innerHTML = `
    <div class="soal-item-header">
      <span class="soal-item-num">Soal PG ${i+1}</span>
    </div>
    <textarea class="soal-input" id="pg-soal-${i}" rows="2">${s.soal}</textarea>
    <div class="opsi-grid">
      ${['A','B','C','D'].map((h, j) => `
        <div class="opsi-wrap">
          <span class="opsi-label">${h}</span>
          <input class="soal-input" id="pg-opsi-${i}-${j}" value="${s.opsi[j]}" style="margin-bottom:0;" placeholder="Opsi ${h}">
        </div>
      `).join('')}
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
      <span style="font-size:12px;font-weight:700;color:var(--green);">‚úî Jawaban:</span>
      <select class="jawaban-select" id="pg-jwb-${i}" style="flex:1;">
        ${['A','B','C','D'].map((h, j) => `<option value="${j}" ${s.jawaban===j?'selected':''}>${h}</option>`).join('')}
      </select>
    </div>
  `;
  return div;
}

function buatCardBS(s, i) {
  const div = document.createElement('div');
  div.className = 'soal-item';
  div.innerHTML = `
    <div class="soal-item-header">
      <span class="soal-item-num">Soal B/S ${i+1}</span>
    </div>
    <textarea class="soal-input" id="bs-soal-${i}" rows="2">${s.soal}</textarea>
    <div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
      <span style="font-size:12px;font-weight:700;color:var(--green);">‚úî Jawaban:</span>
      <select class="jawaban-select" id="bs-jwb-${i}" style="flex:1;">
        <option value="true" ${s.jawaban===true?'selected':''}>BENAR</option>
        <option value="false" ${s.jawaban===false?'selected':''}>SALAH</option>
      </select>
    </div>
  `;
  return div;
}

function buatCardIsian(s, i) {
  const div = document.createElement('div');
  div.className = 'soal-item';
  div.innerHTML = `
    <div class="soal-item-header">
      <span class="soal-item-num">Soal Isian ${i+1}</span>
    </div>
    <textarea class="soal-input" id="is-soal-${i}" rows="2">${s.soal}</textarea>
    <div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
      <span style="font-size:12px;font-weight:700;color:var(--green);">‚úî Jawaban:</span>
      <input class="soal-input" id="is-jwb-${i}" value="${s.jawaban}" style="flex:1;margin-bottom:0;" placeholder="Jawaban...">
    </div>
  `;
  return div;
}

function bacaFormSoal() {
  // Pastikan soalEditor sudah ada
  if (!soalEditor || !soalEditor.pg) {
    alert('Data soal belum dimuat!'); return null;
  }

  const pg = soalEditor.pg.map((s, i) => ({
    soal: document.getElementById(`pg-soal-${i}`)?.value.trim() || s.soal,
    opsi: ['A','B','C','D'].map((_, j) => document.getElementById(`pg-opsi-${i}-${j}`)?.value.trim() || s.opsi[j]),
    jawaban: parseInt(document.getElementById(`pg-jwb-${i}`)?.value ?? s.jawaban)
  }));

  const bs = soalEditor.bs.map((s, i) => ({
    soal: document.getElementById(`bs-soal-${i}`)?.value.trim() || s.soal,
    jawaban: document.getElementById(`bs-jwb-${i}`)?.value === 'true'
  }));

  const is = soalEditor.is.map((s, i) => ({
    soal: document.getElementById(`is-soal-${i}`)?.value.trim() || s.soal,
    jawaban: document.getElementById(`is-jwb-${i}`)?.value.trim() || s.jawaban
  }));

  return { pg, bs, is };
}

function muatEditorDariFirebase() {
  const defaultSoal = () => ({
    pg: JSON.parse(JSON.stringify(soalPG)),
    bs: JSON.parse(JSON.stringify(soalBS)),
    is: JSON.parse(JSON.stringify(soalIsian))
  });
  if (!db) { soalEditor = defaultSoal(); renderEditorSoal(); return; }
  db.ref('soal').once('value').then(snap => {
    soalEditor = snap.exists() ? snap.val() : defaultSoal();
    renderEditorSoal();
  }).catch(() => {
    soalEditor = defaultSoal();
    renderEditorSoal();
  });
}

/* ============================================================
   EMAILJS ‚Äî KIRIM HASIL KE GURU
============================================================ */
const EMAILJS_PUBLIC_KEY  = 'i63TMFLxk7CxJLfee';
const EMAILJS_SERVICE_ID  = 'service_0wcsgqg';
const EMAILJS_TEMPLATE_ID = 'template_kdi9hrj';

// Inisialisasi EmailJS
emailjs.init(EMAILJS_PUBLIC_KEY);

function kirimEmail(data) {
  const predikatMap = {
    90: 'üåü Sempurna! Luar Biasa!',
    80: '‚≠ê Sangat Baik!',
    70: 'üëç Baik!',
    60: 'üìö Cukup, Terus Belajar!',
    0:  'üí™ Semangat Belajar Lebih Giat!'
  };
  let predikat = predikatMap[0];
  if (data.nilai >= 90) predikat = predikatMap[90];
  else if (data.nilai >= 80) predikat = predikatMap[80];
  else if (data.nilai >= 70) predikat = predikatMap[70];
  else if (data.nilai >= 60) predikat = predikatMap[60];

  const params = {
    nama:          data.nama,
    kelas:         data.kelas,
    waktuMulai:    data.waktuMulai || '-',
    waktuSelesai:  data.waktuSelesai || '-',
    durasi:        data.durasi || '-',
    nilai:         data.nilai,
    predikat:      predikat,
    benarPG:       data.benarPG,
    benarBS:       data.benarBS,
    benarIs:       data.benarIs,
    totalBenar:    data.totalBenar,
    totalSalah:    data.totalSalah,
    pelanggaran:   data.pelanggaran,
    kode:          data.kode || '-',
    jawabanIsian:  (data.jawabanIsian || []).map((j, i) => `Isian ${i+1}: ${j || '(kosong)'}`).join('\n'),
  };

  emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params)
    .then(() => console.log('‚úÖ Email hasil ujian terkirim!'))
    .catch(err => console.error('‚ùå Gagal kirim email:', err));
}

// Saat halaman pertama kali dibuka, cek jadwal dulu
muatRekap();
cekJadwal();

/* ============================================================
   ULANG
============================================================ */
function ulangUjian() {
  namaUser=''; kelasUser=''; kodeUnikSesi='';
  waktuMulaiUjian = null; waktuMulaiStr = '';
  jawabanPG = new Array(10).fill(null);
  jawabanBS = new Array(10).fill(null);
  jawabanIsian = new Array(5).fill('');
  soalPGAcak=[]; soalBSAcak=[]; soalIsianAcak=[];
  violationCount = 0; examActive = false;
  hapusWatermark();
  initialWidth = window.innerWidth;
  initialHeight = window.innerHeight;

  // Reset UI
  document.getElementById('nama').value = '';
  document.getElementById('kelas').value = '';
  document.getElementById('kodeUnikExam').textContent = '-';
  document.getElementById('nilaiNum').textContent = '0';
  document.getElementById('nilaiNum').classList.remove('animating');
  document.getElementById('pgContainer').innerHTML = '';
  document.getElementById('bsContainer').innerHTML = '';
  document.getElementById('isianContainer').innerHTML = '';
  document.getElementById('navDots').innerHTML = '';
  document.getElementById('examPage').style.pointerEvents = '';
  document.getElementById('examPage').style.opacity = '';
  document.getElementById('fullscreenBar').classList.remove('show');

  // Kembali ke security bar default
  const bar = document.getElementById('securityBar');
  if (bar) {
    bar.className = 'security-bar safe';
    bar.querySelector('.sec-left span:first-child').textContent = 'üõ°Ô∏è';
    bar.querySelector('.sec-left span:nth-child(2)').textContent = 'Mode Aman Aktif';
    bar.querySelector('.sec-badge').textContent = 'TERLINDUNGI';
    document.getElementById('secViolationText').textContent = '0 / 3 pelanggaran';
  }

  sembunyikanSemua();
  cekJadwal();
  window.scrollTo({ top:0, behavior:'smooth' });
}
</script>
</body>
</html>
